<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>问答功能测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .test-button {
            background: #409eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }
        .test-result {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
            white-space: pre-wrap;
        }
        .error {
            background: #fef2f2;
            border-color: #fecaca;
            color: #dc2626;
        }
        .success {
            background: #f0fdf4;
            border-color: #bbf7d0;
            color: #16a34a;
        }
    </style>
</head>
<body>
    <h1>🤖 IQE AI智能助手 - 问答功能测试</h1>
    
    <div class="test-container">
        <h2>📋 测试说明</h2>
        <p>此页面用于测试AI智能助手的问答功能。请在下方输入问题进行测试。</p>
        <p><strong>注意</strong>：此测试页面需要在IQE应用运行时使用，确保 http://localhost:5173 可访问。</p>
    </div>

    <div class="test-container">
        <h2>🔍 基础功能测试</h2>
        <input type="text" class="test-input" id="basicQuery" placeholder="输入问题，如：查询深圳工厂库存" value="查询深圳工厂库存">
        <button class="test-button" onclick="testBasicQuery()">测试基础问答</button>
        <div id="basicResult" class="test-result" style="display: none;"></div>
    </div>

    <div class="test-container">
        <h2>🤖 AI功能测试</h2>
        <input type="text" class="test-input" id="aiQuery" placeholder="输入复杂问题，如：分析深圳工厂的整体质量状况" value="分析深圳工厂的整体质量状况">
        <button class="test-button" onclick="testAIQuery()">测试AI分析</button>
        <div id="aiResult" class="test-result" style="display: none;"></div>
    </div>

    <div class="test-container">
        <h2>📊 预设测试用例</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
            <button class="test-button" onclick="runTestCase('查询风险库存')">查询风险库存</button>
            <button class="test-button" onclick="runTestCase('BOE供应商表现')">BOE供应商表现</button>
            <button class="test-button" onclick="runTestCase('深圳工厂质量状况')">深圳工厂质量状况</button>
            <button class="test-button" onclick="runTestCase('生产不良率分析')">生产不良率分析</button>
            <button class="test-button" onclick="runTestCase('显示库存状态图表')">显示库存状态图表</button>
            <button class="test-button" onclick="runTestCase('测试失败记录')">测试失败记录</button>
        </div>
        <div id="testCaseResult" class="test-result" style="display: none;"></div>
    </div>

    <div class="test-container">
        <h2>🔧 API连接测试</h2>
        <button class="test-button" onclick="testAPIConnection()">测试DeepSeek API连接</button>
        <div id="apiResult" class="test-result" style="display: none;"></div>
    </div>

    <script>
        // 基础问答测试
        async function testBasicQuery() {
            const query = document.getElementById('basicQuery').value;
            const resultDiv = document.getElementById('basicResult');
            
            resultDiv.style.display = 'block';
            resultDiv.className = 'test-result';
            resultDiv.textContent = '🔍 正在测试基础问答功能...';
            
            try {
                // 模拟基础问答逻辑
                const result = simulateBasicQuery(query);
                resultDiv.className = 'test-result success';
                resultDiv.textContent = `✅ 基础问答测试成功！\n\n查询: ${query}\n回复: ${result.reply}`;
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `❌ 基础问答测试失败: ${error.message}`;
            }
        }

        // AI分析测试
        async function testAIQuery() {
            const query = document.getElementById('aiQuery').value;
            const resultDiv = document.getElementById('aiResult');
            
            resultDiv.style.display = 'block';
            resultDiv.className = 'test-result';
            resultDiv.textContent = '🤖 正在测试AI分析功能...';
            
            try {
                const result = await testDeepSeekAPI(query);
                resultDiv.className = 'test-result success';
                resultDiv.textContent = `✅ AI分析测试成功！\n\n查询: ${query}\n回复: ${result.content || '测试完成'}`;
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `❌ AI分析测试失败: ${error.message}`;
            }
        }

        // 运行测试用例
        async function runTestCase(testQuery) {
            const resultDiv = document.getElementById('testCaseResult');
            
            resultDiv.style.display = 'block';
            resultDiv.className = 'test-result';
            resultDiv.textContent = `🧪 正在运行测试用例: ${testQuery}...`;
            
            try {
                const result = simulateBasicQuery(testQuery);
                resultDiv.className = 'test-result success';
                resultDiv.textContent = `✅ 测试用例执行成功！\n\n测试: ${testQuery}\n结果: ${result.reply}`;
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `❌ 测试用例执行失败: ${error.message}`;
            }
        }

        // API连接测试
        async function testAPIConnection() {
            const resultDiv = document.getElementById('apiResult');
            
            resultDiv.style.display = 'block';
            resultDiv.className = 'test-result';
            resultDiv.textContent = '🔍 正在测试DeepSeek API连接...';
            
            try {
                const result = await testDeepSeekAPI('你好，请简单介绍一下你的能力');
                resultDiv.className = 'test-result success';
                resultDiv.textContent = `✅ API连接测试成功！\n\n响应: ${result.content || '连接正常'}`;
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `❌ API连接测试失败: ${error.message}\n\n可能原因:\n- 网络连接问题\n- API密钥无效\n- CORS跨域限制`;
            }
        }

        // 模拟基础问答
        function simulateBasicQuery(query) {
            const mockData = {
                inventory: 132,
                riskItems: 15,
                factories: ['深圳工厂', '上海工厂', '北京工厂'],
                suppliers: ['BOE', '华星光电', '三星电子']
            };

            if (query.includes('库存')) {
                if (query.includes('风险')) {
                    return { reply: `当前共有 ${mockData.riskItems} 个风险库存项目` };
                }
                if (query.includes('深圳')) {
                    return { reply: `深圳工厂库存概况：总计 44 个物料项目，正常: 35个，风险: 6个，冻结: 3个` };
                }
                return { reply: `库存总览：总计 ${mockData.inventory} 个库存项目` };
            }

            if (query.includes('BOE') || query.includes('供应商')) {
                return { reply: `BOE供应商分析：库存物料: 28个，平均不良率: 2.3%` };
            }

            if (query.includes('质量') || query.includes('不良率')) {
                return { reply: `质量状况分析：测试失败率: 8.5%，平均不良率: 3.2%` };
            }

            if (query.includes('图表')) {
                return { reply: `库存状态分布图表已生成。正常: 102个，风险: 15个，冻结: 15个` };
            }

            return { reply: `我理解您询问的是"${query}"。请尝试更具体的问题。` };
        }

        // 测试DeepSeek API
        async function testDeepSeekAPI(query) {
            const apiKey = 'sk-cab797574abf4288bcfaca253191565d';
            const baseURL = 'https://api.deepseek.com';
            const endpoint = '/chat/completions';
            
            const response = await fetch(baseURL + endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'deepseek-chat',
                    messages: [
                        {
                            role: 'system',
                            content: '你是一个质量管理专家，请简洁回答。'
                        },
                        {
                            role: 'user',
                            content: query
                        }
                    ],
                    max_tokens: 100,
                    temperature: 0.7,
                    stream: false
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`API错误 ${response.status}: ${errorData.error?.message || response.statusText}`);
            }
            
            const data = await response.json();
            return {
                content: data.choices[0].message.content,
                model: data.model,
                usage: data.usage
            };
        }

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🤖 问答功能测试页面已加载');
            console.log('📋 可用测试功能:');
            console.log('   1. 基础问答测试');
            console.log('   2. AI分析测试');
            console.log('   3. 预设测试用例');
            console.log('   4. API连接测试');
        });
    </script>
</body>
</html>
