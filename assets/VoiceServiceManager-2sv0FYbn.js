class g{constructor(){this.config={apiKey:"sk-cab797574abf4288bcfaca253191565d",baseURL:"https://api.deepseek.com/v1/chat/completions",model:"deepseek-chat",timeout:3e4,maxRetries:3},this.isAvailable=!1,this.lastHealthCheck=null,this.healthCheckInterval=5*60*1e3}async initialize(){return console.log("ğŸ¤– åˆå§‹åŒ–AIæœåŠ¡ç®¡ç†å™¨..."),await this.healthCheck(),this.isAvailable}async healthCheck(){try{console.log("ğŸ” æ‰§è¡ŒAIæœåŠ¡å¥åº·æ£€æŸ¥...");const e=await fetch(this.config.baseURL,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`},body:JSON.stringify({model:this.config.model,messages:[{role:"user",content:"æµ‹è¯•è¿æ¥"}],max_tokens:10}),signal:AbortSignal.timeout(5e3)});e.ok?(this.isAvailable=!0,this.lastHealthCheck=Date.now(),console.log("âœ… AIæœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡")):(this.isAvailable=!1,console.warn("âš ï¸ AIæœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥:",e.status))}catch(e){this.isAvailable=!1,console.warn("âš ï¸ AIæœåŠ¡å¥åº·æ£€æŸ¥å¼‚å¸¸:",e.message)}return this.isAvailable}async analyzeUserIntent(e){console.log("ğŸ§  åˆ†æç”¨æˆ·æ„å›¾:",e);const t=this.basicIntentAnalysis(e);if(!this.isAvailable)return console.log("âš ï¸ AIæœåŠ¡ä¸å¯ç”¨ï¼Œä½¿ç”¨åŸºç¡€åˆ†æ"),t;try{const s=await this.aiIntentAnalysis(e);return{...t,...s,confidence:Math.max(t.confidence,s.confidence||.5),source:"ai_enhanced"}}catch(s){return console.warn("âš ï¸ AIæ„å›¾åˆ†æå¤±è´¥ï¼Œä½¿ç”¨åŸºç¡€åˆ†æ:",s.message),t}}basicIntentAnalysis(e){const t=e.toLowerCase(),s=["æŸ¥è¯¢","æŸ¥çœ‹","æ˜¾ç¤º","ç»Ÿè®¡","åˆ†æ","æŠ¥å‘Š","åº“å­˜","ç‰©æ–™","ä¾›åº”å•†","å·¥å‚","æµ‹è¯•","æ£€éªŒ","æ‰¹æ¬¡","ä¸è‰¯ç‡","åˆæ ¼ç‡","é£é™©","å¼‚å¸¸"],n=["ä»€ä¹ˆæ˜¯","å¦‚ä½•","ä¸ºä»€ä¹ˆ","æ€ä¹ˆ","å»ºè®®","æ¨è","æœ€ä½³å®è·µ","æ ‡å‡†","è§„èŒƒ","æµç¨‹","æ–¹æ³•"],o=s.filter(l=>t.includes(l)).length,i=n.filter(l=>t.includes(l)).length;let r="general",a=!1,c=.3;return o>i?(r="data_query",a=!0,c=Math.min(.8,.3+o*.1)):i>0&&(r="consultation",a=!1,c=Math.min(.7,.3+i*.1)),{intent:r,needsDataQuery:a,confidence:c,keywords:{dataQuery:o,consultation:i},source:"rule_based"}}async aiIntentAnalysis(e){const t=`
ä½œä¸ºQMSé—®ç­”åŠ©æ‰‹-å°Qï¼Œè¯·åˆ†æä»¥ä¸‹ç”¨æˆ·é—®é¢˜çš„æ„å›¾ï¼š

ç”¨æˆ·é—®é¢˜ï¼š"${e}"

è¯·åˆ¤æ–­ï¼š
1. ç”¨æˆ·æ„å›¾ç±»å‹ï¼ˆdata_query: æ•°æ®æŸ¥è¯¢, consultation: å’¨è¯¢é—®ç­”, general: ä¸€èˆ¬å¯¹è¯ï¼‰
2. æ˜¯å¦éœ€è¦æŸ¥è¯¢æ•°æ®åº“æ•°æ®ï¼ˆtrue/falseï¼‰
3. ç½®ä¿¡åº¦ï¼ˆ0-1ä¹‹é—´çš„æ•°å€¼ï¼‰
4. å…³é”®ä¿¡æ¯æå–

è¯·ä»¥JSONæ ¼å¼å›å¤ï¼š
{
  "intent": "data_query|consultation|general",
  "needsDataQuery": true|false,
  "confidence": 0.8,
  "extractedInfo": {
    "entities": ["å®ä½“1", "å®ä½“2"],
    "queryType": "åº“å­˜æŸ¥è¯¢|è´¨é‡åˆ†æ|ä¾›åº”å•†è¯„ä¼°|ç­‰",
    "scope": "å…·ä½“èŒƒå›´"
  },
  "reasoning": "åˆ†æç†ç”±"
}
`;try{const s=await this.callDeepSeek(t),n=JSON.parse(s);return console.log("ğŸ¤– AIæ„å›¾åˆ†æç»“æœ:",n),n}catch(s){return console.warn("âš ï¸ AIæ„å›¾åˆ†æè§£æå¤±è´¥:",s.message),{confidence:.3}}}async callDeepSeek(e,t={}){if(!this.isAvailable)throw new Error("AIæœåŠ¡ä¸å¯ç”¨");const s={model:this.config.model,messages:[{role:"user",content:e}],temperature:t.temperature||.7,max_tokens:t.maxTokens||2e3,stream:!1};let n=null;for(let o=1;o<=this.config.maxRetries;o++)try{console.log(`ğŸ”„ AIè°ƒç”¨å°è¯• ${o}/${this.config.maxRetries}`);const i=await fetch(this.config.baseURL,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`},body:JSON.stringify(s),signal:AbortSignal.timeout(this.config.timeout)});if(!i.ok){const a=await i.text();throw new Error(`APIé”™è¯¯ ${i.status}: ${a}`)}const r=await i.json();return console.log("âœ… AIè°ƒç”¨æˆåŠŸ"),r.choices[0].message.content}catch(i){if(n=i,console.warn(`âš ï¸ AIè°ƒç”¨å°è¯• ${o} å¤±è´¥:`,i.message),o<this.config.maxRetries){const r=Math.pow(2,o)*1e3;await new Promise(a=>setTimeout(a,r))}}throw this.isAvailable=!1,n||new Error("AIæœåŠ¡è°ƒç”¨å¤±è´¥")}generateFallbackResponse(e,t){const s={data_query:`æŠ±æ­‰ï¼Œå°Qçš„AIå¢å¼ºåŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨ã€‚æˆ‘å·²æ”¶åˆ°æ‚¨å…³äº"${e}"çš„æŸ¥è¯¢è¯·æ±‚ï¼Œæ­£åœ¨å°è¯•é€šè¿‡åŸºç¡€è§„åˆ™ä¸ºæ‚¨å¤„ç†...`,consultation:`æˆ‘æ˜¯å°Qï¼Œæ‚¨çš„è´¨é‡ç®¡ç†åŠ©æ‰‹ã€‚å…³äºæ‚¨çš„é—®é¢˜"${e}"ï¼Œè™½ç„¶AIå¢å¼ºåŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨ï¼Œä½†æˆ‘å¯ä»¥åŸºäºä¸“ä¸šçŸ¥è¯†ä¸ºæ‚¨æä¾›åŸºç¡€å»ºè®®...`,general:`æ‚¨å¥½ï¼æˆ‘æ˜¯å°Qã€‚æˆ‘æ”¶åˆ°äº†æ‚¨çš„é—®é¢˜"${e}"ï¼Œè™½ç„¶æ™ºèƒ½åˆ†æåŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨ï¼Œä½†æˆ‘ä¼šå°½åŠ›ä¸ºæ‚¨æä¾›å¸®åŠ©...`};return s[t]||s.general}shouldPerformHealthCheck(){return this.lastHealthCheck?Date.now()-this.lastHealthCheck>this.healthCheckInterval:!0}}const f=new g;class u{constructor(){this.isSupported=!1,this.isListening=!1,this.isSpeaking=!1,this.recognition=null,this.recognitionConfig={continuous:!1,interimResults:!0,lang:"zh-CN",maxAlternatives:1},this.synthesis=null,this.synthesisConfig={lang:"zh-CN",rate:1,pitch:1,volume:1},this.onResult=null,this.onError=null,this.onStart=null,this.onEnd=null,this.onSpeechStart=null,this.onSpeechEnd=null,this.init()}init(){console.log("ğŸ¤ åˆå§‹åŒ–è¯­éŸ³æœåŠ¡..."),this.checkSupport(),this.isSupported?(this.initRecognition(),this.initSynthesis(),console.log("âœ… è¯­éŸ³æœåŠ¡åˆå§‹åŒ–æˆåŠŸ")):console.warn("âš ï¸ å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åŠŸèƒ½")}checkSupport(){const e=window.SpeechRecognition||window.webkitSpeechRecognition,t=window.speechSynthesis;return this.isSupported=!!(e&&t),e||console.warn("âš ï¸ æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«"),t||console.warn("âš ï¸ æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆ"),this.isSupported}initRecognition(){const e=window.SpeechRecognition||window.webkitSpeechRecognition;e&&(this.recognition=new e,Object.assign(this.recognition,this.recognitionConfig),this.recognition.onstart=()=>{console.log("ğŸ¤ è¯­éŸ³è¯†åˆ«å¼€å§‹"),this.isListening=!0,this.onStart&&this.onStart()},this.recognition.onresult=t=>{console.log("ğŸ¤ è¯­éŸ³è¯†åˆ«ç»“æœäº‹ä»¶:",t),console.log("ğŸ¤ ç»“æœæ•°é‡:",t.results.length);let s="",n="",o=0;for(let r=t.resultIndex;r<t.results.length;r++){const a=t.results[r],c=a[0].transcript,l=a[0].confidence||0;console.log(`ğŸ¤ ç»“æœ ${r}: "${c}" (final: ${a.isFinal}, confidence: ${l})`),a.isFinal?(s+=c,o=Math.max(o,l)):n+=c}const i={final:s.trim(),interim:n.trim(),confidence:o};console.log("ğŸ¤ å¤„ç†åçš„è¯†åˆ«ç»“æœ:",i),this.onResult&&this.onResult(i)},this.recognition.onerror=t=>{console.error("âŒ è¯­éŸ³è¯†åˆ«é”™è¯¯:",t.error),this.isListening=!1,this.onError&&this.onError(t.error)},this.recognition.onend=()=>{console.log("ğŸ¤ è¯­éŸ³è¯†åˆ«ç»“æŸ"),this.isListening=!1,this.onEnd&&this.onEnd()})}initSynthesis(){this.synthesis=window.speechSynthesis,this.synthesis&&(this.getVoices(),this.synthesis.onvoiceschanged=()=>{this.getVoices()})}getVoices(){if(!this.synthesis)return[];const e=this.synthesis.getVoices();console.log("ğŸ”Š å¯ç”¨è¯­éŸ³:",e.length);const t=e.filter(s=>s.lang.includes("zh")||s.lang.includes("CN"));return t.length>0&&(this.preferredVoice=t[0],console.log("ğŸ”Š é€‰æ‹©ä¸­æ–‡è¯­éŸ³:",this.preferredVoice.name)),e}startListening(){if(!this.isSupported||!this.recognition)return console.warn("âš ï¸ è¯­éŸ³è¯†åˆ«ä¸å¯ç”¨"),this.onError&&this.onError("è¯­éŸ³è¯†åˆ«ä¸å¯ç”¨"),!1;if(this.isListening)return console.warn("âš ï¸ è¯­éŸ³è¯†åˆ«å·²åœ¨è¿›è¡Œä¸­"),!1;try{return console.log("ğŸ¤ å¼€å§‹è¯­éŸ³è¯†åˆ«..."),console.log("ğŸ¤ è¯†åˆ«é…ç½®:",this.recognitionConfig),Object.assign(this.recognition,this.recognitionConfig),this.recognition.start(),console.log("ğŸ¤ è¯­éŸ³è¯†åˆ«å¯åŠ¨å‘½ä»¤å·²å‘é€"),!0}catch(e){console.error("âŒ å¯åŠ¨è¯­éŸ³è¯†åˆ«å¤±è´¥:",e),console.error("âŒ é”™è¯¯è¯¦æƒ…:",e.name,e.message);let t=e.message;return e.name==="NotAllowedError"?t="éº¦å…‹é£æƒé™è¢«æ‹’ç»ï¼Œè¯·å…è®¸ç½‘ç«™è®¿é—®éº¦å…‹é£":e.name==="NotFoundError"?t="æœªæ‰¾åˆ°éº¦å…‹é£è®¾å¤‡":e.name==="NotSupportedError"&&(t="æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«"),this.onError&&this.onError(t),!1}}stopListening(){if(!this.recognition||!this.isListening)return!1;try{return console.log("ğŸ¤ åœæ­¢è¯­éŸ³è¯†åˆ«..."),this.recognition.stop(),!0}catch(e){return console.error("âŒ åœæ­¢è¯­éŸ³è¯†åˆ«å¤±è´¥:",e),!1}}speak(e,t={}){if(!this.isSupported||!this.synthesis)return console.warn("âš ï¸ è¯­éŸ³åˆæˆä¸å¯ç”¨"),!1;this.isSpeaking&&(console.log("ğŸ”Š åœæ­¢å½“å‰è¯­éŸ³æ’­æ”¾"),this.synthesis.cancel());const s=new SpeechSynthesisUtterance(e);s.lang=t.lang||this.synthesisConfig.lang,s.rate=t.rate||this.synthesisConfig.rate,s.pitch=t.pitch||this.synthesisConfig.pitch,s.volume=t.volume||this.synthesisConfig.volume,this.preferredVoice&&(s.voice=this.preferredVoice),s.onstart=()=>{console.log("ğŸ”Š è¯­éŸ³æ’­æ”¾å¼€å§‹"),this.isSpeaking=!0,this.onSpeechStart&&this.onSpeechStart()},s.onend=()=>{console.log("ğŸ”Š è¯­éŸ³æ’­æ”¾ç»“æŸ"),this.isSpeaking=!1,this.onSpeechEnd&&this.onSpeechEnd()},s.onerror=n=>{console.error("âŒ è¯­éŸ³æ’­æ”¾é”™è¯¯:",n.error),this.isSpeaking=!1,this.onError&&this.onError(n.error)};try{return console.log("ğŸ”Š å¼€å§‹è¯­éŸ³æ’­æ”¾:",e.substring(0,50)+"..."),this.synthesis.speak(s),!0}catch(n){return console.error("âŒ è¯­éŸ³æ’­æ”¾å¤±è´¥:",n),this.onError&&this.onError(n.message),!1}}stopSpeaking(){if(!this.synthesis)return!1;try{return console.log("ğŸ”Š åœæ­¢è¯­éŸ³æ’­æ”¾"),this.synthesis.cancel(),this.isSpeaking=!1,!0}catch(e){return console.error("âŒ åœæ­¢è¯­éŸ³æ’­æ”¾å¤±è´¥:",e),!1}}setCallbacks(e){this.onResult=e.onResult,this.onError=e.onError,this.onStart=e.onStart,this.onEnd=e.onEnd,this.onSpeechStart=e.onSpeechStart,this.onSpeechEnd=e.onSpeechEnd}getStatus(){return{isSupported:this.isSupported,isListening:this.isListening,isSpeaking:this.isSpeaking,hasVoices:!!this.preferredVoice}}}const p=new u;export{f as a,p as v};
