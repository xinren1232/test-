import d from"./8DReportAnalyzer-BsKXd43f.js";class g{constructor(){this.analyzer=d,this.extractionRules=this.initializeExtractionRules(),this.validationRules=this.initializeValidationRules(),this.qualityMetrics=this.initializeQualityMetrics()}initializeExtractionRules(){return{D1:{patterns:{teamMembers:[/团队成员[：:]?\s*([^。\n]+)/gi,/成员[：:]?\s*([^。\n]+)/gi,/Team\s+Members?[：:]?\s*([^。\n]+)/gi],roles:[/角色[：:]?\s*([^。\n]+)/gi,/职责[：:]?\s*([^。\n]+)/gi,/Role[s]?[：:]?\s*([^。\n]+)/gi],leader:[/组长[：:]?\s*([^。\n]+)/gi,/负责人[：:]?\s*([^。\n]+)/gi,/Leader[：:]?\s*([^。\n]+)/gi],contact:[/联系方式[：:]?\s*([^。\n]+)/gi,/电话[：:]?\s*([^。\n]+)/gi,/Contact[：:]?\s*([^。\n]+)/gi]},requiredFields:["teamMembers","roles","leader"],optionalFields:["contact"],validationRules:{minTeamSize:3,maxTeamSize:10,requiredRoles:["组长","技术专家","质量工程师"]}},D2:{patterns:{problemDescription:[/问题描述[：:]?\s*([^D\d]+)/gi,/问题现象[：:]?\s*([^D\d]+)/gi,/Problem\s+Description[：:]?\s*([^D\d]+)/gi],occurrence:[/发生时间[：:]?\s*([^。\n]+)/gi,/时间[：:]?\s*([^。\n]+)/gi,/Occurrence[：:]?\s*([^。\n]+)/gi],impact:[/影响范围[：:]?\s*([^。\n]+)/gi,/影响[：:]?\s*([^。\n]+)/gi,/Impact[：:]?\s*([^。\n]+)/gi],severity:[/严重程度[：:]?\s*([^。\n]+)/gi,/等级[：:]?\s*([^。\n]+)/gi,/Severity[：:]?\s*([^。\n]+)/gi],customer:[/客户[：:]?\s*([^。\n]+)/gi,/Customer[：:]?\s*([^。\n]+)/gi]},requiredFields:["problemDescription","occurrence","impact"],optionalFields:["severity","customer"],validationRules:{minDescriptionLength:50,requiresQuantification:!0,mustHaveTimeframe:!0}},D3:{patterns:{interimActions:[/临时措施[：:]?\s*([^D\d]+)/gi,/应急措施[：:]?\s*([^D\d]+)/gi,/Interim\s+Actions?[：:]?\s*([^D\d]+)/gi],implementation:[/实施时间[：:]?\s*([^。\n]+)/gi,/执行时间[：:]?\s*([^。\n]+)/gi,/Implementation[：:]?\s*([^。\n]+)/gi],verification:[/效果验证[：:]?\s*([^。\n]+)/gi,/验证[：:]?\s*([^。\n]+)/gi,/Verification[：:]?\s*([^。\n]+)/gi],responsible:[/负责人[：:]?\s*([^。\n]+)/gi,/责任人[：:]?\s*([^。\n]+)/gi,/Responsible[：:]?\s*([^。\n]+)/gi]},requiredFields:["interimActions","implementation","verification"],optionalFields:["responsible"],validationRules:{mustBeTemporary:!0,requiresVerification:!0,timeframeDefined:!0}},D4:{patterns:{rootCause:[/根本原因[：:]?\s*([^D\d]+)/gi,/根因[：:]?\s*([^D\d]+)/gi,/Root\s+Cause[：:]?\s*([^D\d]+)/gi],analysisMethod:[/分析方法[：:]?\s*([^。\n]+)/gi,/方法[：:]?\s*([^。\n]+)/gi,/Method[：:]?\s*([^。\n]+)/gi],evidence:[/证据[：:]?\s*([^。\n]+)/gi,/验证结果[：:]?\s*([^。\n]+)/gi,/Evidence[：:]?\s*([^。\n]+)/gi],tools:[/工具[：:]?\s*([^。\n]+)/gi,/使用工具[：:]?\s*([^。\n]+)/gi,/Tools?[：:]?\s*([^。\n]+)/gi]},requiredFields:["rootCause","analysisMethod","evidence"],optionalFields:["tools"],validationRules:{requiresSystematicAnalysis:!0,mustHaveEvidence:!0,knownMethods:["5Why","鱼骨图","FMEA","因果图"]}},D5:{patterns:{correctiveActions:[/永久措施[：:]?\s*([^D\d]+)/gi,/纠正措施[：:]?\s*([^D\d]+)/gi,/Corrective\s+Actions?[：:]?\s*([^D\d]+)/gi],implementation:[/实施计划[：:]?\s*([^。\n]+)/gi,/计划[：:]?\s*([^。\n]+)/gi,/Plan[：:]?\s*([^。\n]+)/gi],expectedEffect:[/预期效果[：:]?\s*([^。\n]+)/gi,/效果[：:]?\s*([^。\n]+)/gi,/Expected\s+Effect[：:]?\s*([^。\n]+)/gi],verification:[/验证方法[：:]?\s*([^。\n]+)/gi,/验证[：:]?\s*([^。\n]+)/gi,/Verification[：:]?\s*([^。\n]+)/gi]},requiredFields:["correctiveActions","implementation","expectedEffect"],optionalFields:["verification"],validationRules:{mustAddressRootCause:!0,requiresTimeline:!0,mustBeVerifiable:!0}},D6:{patterns:{implementationStatus:[/实施状态[：:]?\s*([^。\n]+)/gi,/状态[：:]?\s*([^。\n]+)/gi,/Status[：:]?\s*([^。\n]+)/gi],verificationResults:[/验证结果[：:]?\s*([^。\n]+)/gi,/结果[：:]?\s*([^。\n]+)/gi,/Results?[：:]?\s*([^。\n]+)/gi],effectiveness:[/效果评估[：:]?\s*([^。\n]+)/gi,/评估[：:]?\s*([^。\n]+)/gi,/Effectiveness[：:]?\s*([^。\n]+)/gi],completion:[/完成时间[：:]?\s*([^。\n]+)/gi,/完成[：:]?\s*([^。\n]+)/gi,/Completion[：:]?\s*([^。\n]+)/gi]},requiredFields:["implementationStatus","verificationResults","effectiveness"],optionalFields:["completion"],validationRules:{mustShowProgress:!0,requiresEvidence:!0,effectivenessMeasured:!0}},D7:{patterns:{preventiveMeasures:[/预防措施[：:]?\s*([^D\d]+)/gi,/预防[：:]?\s*([^D\d]+)/gi,/Prevention[：:]?\s*([^D\d]+)/gi],systemImprovement:[/系统改进[：:]?\s*([^。\n]+)/gi,/改进[：:]?\s*([^。\n]+)/gi,/Improvement[：:]?\s*([^。\n]+)/gi],processOptimization:[/流程优化[：:]?\s*([^。\n]+)/gi,/流程[：:]?\s*([^。\n]+)/gi,/Process[：:]?\s*([^。\n]+)/gi],training:[/培训计划[：:]?\s*([^。\n]+)/gi,/培训[：:]?\s*([^。\n]+)/gi,/Training[：:]?\s*([^。\n]+)/gi]},requiredFields:["preventiveMeasures","systemImprovement"],optionalFields:["processOptimization","training"],validationRules:{mustPreventRecurrence:!0,systemicApproach:!0,sustainabilityConsidered:!0}},D8:{patterns:{teamContribution:[/团队贡献[：:]?\s*([^。\n]+)/gi,/贡献[：:]?\s*([^。\n]+)/gi,/Contribution[：:]?\s*([^。\n]+)/gi],recognition:[/表彰方式[：:]?\s*([^。\n]+)/gi,/表彰[：:]?\s*([^。\n]+)/gi,/Recognition[：:]?\s*([^。\n]+)/gi],lessonsLearned:[/经验总结[：:]?\s*([^。\n]+)/gi,/总结[：:]?\s*([^。\n]+)/gi,/Lessons\s+Learned[：:]?\s*([^。\n]+)/gi],knowledgeSharing:[/知识分享[：:]?\s*([^。\n]+)/gi,/分享[：:]?\s*([^。\n]+)/gi,/Knowledge\s+Sharing[：:]?\s*([^。\n]+)/gi]},requiredFields:["teamContribution","recognition"],optionalFields:["lessonsLearned","knowledgeSharing"],validationRules:{mustRecognizeTeam:!0,encouragesLearning:!0,promotesSharing:!0}}}}initializeValidationRules(){return{global:{minDimensionsRequired:6,minContentLength:100,maxContentLength:5e3,timelineConsistency:!0,crossReferenceCheck:!0},quality:{completenessThreshold:.7,accuracyThreshold:.8,consistencyThreshold:.75,clarityThreshold:.7},business:{mustHaveCustomerImpact:!0,mustHaveTimeline:!0,mustHaveOwnership:!0,mustHaveVerification:!0}}}initializeQualityMetrics(){return{completeness:{weight:.3,calculation:"fieldsCompleted / totalRequiredFields"},accuracy:{weight:.25,calculation:"validatedFields / totalFields"},consistency:{weight:.2,calculation:"consistentReferences / totalReferences"},clarity:{weight:.15,calculation:"clearStatements / totalStatements"},actionability:{weight:.1,calculation:"actionableItems / totalItems"}}}async extract8DData(e,i="text",s=""){try{console.log("🔍 开始8D数据提取...");const t=await this.analyzer.identify8DReport(e,s);if(!t.is8DReport)throw new Error(`文件不是标准8D报告格式 (置信度: ${(t.confidence*100).toFixed(1)}%)`);const n=await this.analyzer.parse8DContent(e,i);if(!n.success)throw new Error(`8D内容解析失败: ${n.error}`);const r=this.performSpecializedExtraction(n.dimensions),o=this.performQualityAssessment(r),c=this.generateExtractionReport(t,n,r,o);return console.log("✅ 8D数据提取完成"),{success:!0,identification:t,extractedData:r,qualityAssessment:o,extractionReport:c,metadata:n.metadata,suggestions:n.suggestions}}catch(t){return console.error("❌ 8D数据提取失败:",t),{success:!1,error:t.message,extractedData:null,qualityAssessment:null}}}performSpecializedExtraction(e){const i={};return Object.keys(this.extractionRules).forEach(s=>{const t=this.extractionRules[s],n=e[s];if(!n||!n.content){i[s]=this.createEmptyDimensionData(t);return}i[s]=this.extractDimensionData(n.content,t,s)}),i}createEmptyDimensionData(e){const i={extracted:!1,fields:{},quality:{completeness:0,accuracy:0,clarity:0},issues:["维度内容缺失"]};return e.requiredFields.concat(e.optionalFields).forEach(t=>{i.fields[t]=null}),i}extractDimensionData(e,i,s){const t={extracted:!0,fields:{},quality:{},issues:[],confidence:0};return i.requiredFields.concat(i.optionalFields).forEach(r=>{t.fields[r]=this.extractField(e,i.patterns[r]||[],r)}),t.quality=this.assessExtractionQuality(t.fields,i,e),t.issues=this.validateExtractionRules(t.fields,i.validationRules,s),t.confidence=this.calculateExtractionConfidence(t.fields,t.quality,t.issues),t}extractField(e,i,s){if(!i||i.length===0)return null;for(const t of i){const n=e.match(t);if(n&&n.length>0){const r=n[0].replace(t,"$1").trim();if(r&&r.length>0)return{value:r,confidence:this.calculateFieldConfidence(r,s),source:"pattern_match",pattern:t.toString()}}}return this.extractByKeywordSearch(e,s)}extractByKeywordSearch(e,i){const t={teamMembers:["成员","人员","团队"],roles:["角色","职责","分工"],leader:["组长","负责人","主管"],problemDescription:["问题","现象","故障"],occurrence:["时间","发生","出现"],impact:["影响","范围","后果"],rootCause:["原因","根因","起因"],correctiveActions:["措施","行动","方案"]}[i]||[],n=e.split(/[。！？.!?]/);for(const r of n)for(const o of t)if(r.includes(o))return{value:r.trim(),confidence:.6,source:"keyword_search",keyword:o};return null}calculateFieldConfidence(e,i){let s=.5;switch(e.length>10&&(s+=.2),e.length>50&&(s+=.1),i){case"teamMembers":/[，,]/.test(e)&&(s+=.2);break;case"occurrence":/\d{4}[-\/]\d{1,2}[-\/]\d{1,2}/.test(e)&&(s+=.3);break;case"rootCause":e.length>30&&(s+=.2);break}return Math.min(s,1)}assessExtractionQuality(e,i,s){const t={completeness:0,accuracy:0,clarity:0,overall:0},n=i.requiredFields.length,r=i.requiredFields.filter(c=>e[c]&&e[c].value).length;t.completeness=r/n;const o=Object.values(e).filter(c=>c&&c.value);return o.length>0&&(t.accuracy=o.reduce((c,a)=>c+a.confidence,0)/o.length),t.clarity=this.assessContentClarity(s),t.overall=t.completeness*.4+t.accuracy*.4+t.clarity*.2,t}assessContentClarity(e){let i=.5;return/[：:]/.test(e)&&(i+=.2),/\d+[、.]/.test(e)&&(i+=.1),/\n/.test(e)&&(i+=.1),e.length>50&&e.length<500&&(i+=.1),Math.min(i,1)}validateExtractionRules(e,i,s){const t=[];return i&&Object.keys(i).forEach(n=>{const r=i[n];switch(n){case"minTeamSize":e.teamMembers&&e.teamMembers.value&&(e.teamMembers.value.match(/[，,]/g)||[]).length+1<r&&t.push(`团队成员数量不足，建议至少${r}人`);break;case"minDescriptionLength":e.problemDescription&&e.problemDescription.value&&e.problemDescription.value.length<r&&t.push(`问题描述过于简单，建议至少${r}字`);break;case"requiresQuantification":e.problemDescription&&e.problemDescription.value&&(/\d/.test(e.problemDescription.value)||t.push("问题描述缺少量化数据"));break;case"mustHaveTimeframe":(!e.occurrence||!e.occurrence.value)&&t.push("缺少时间信息");break;case"requiresSystematicAnalysis":e.analysisMethod&&e.analysisMethod.value&&((i.knownMethods||[]).some(a=>e.analysisMethod.value.includes(a))||t.push("建议使用系统性分析方法（如5Why、鱼骨图等）"));break}}),t}calculateExtractionConfidence(e,i,s){let t=i.overall;const n=s.length;n>0&&(t*=Math.max(.3,1-n*.1));const r=Object.keys(e).length,c=Object.values(e).filter(a=>a&&a.value).length/r;return t=(t+c)/2,Math.min(t,1)}performQualityAssessment(e){const i={overall:{score:0,grade:"F",status:"poor"},dimensions:{},metrics:{},recommendations:[]};let s=0,t=0;return Object.keys(e).forEach(n=>{const r=e[n],o=this.assessDimensionQuality(r,n);i.dimensions[n]=o,s+=o.score,t++}),i.overall.score=t>0?s/t:0,i.overall.grade=this.calculateGrade(i.overall.score),i.overall.status=this.determineStatus(i.overall.score),i.metrics=this.calculateQualityMetrics(e),i.recommendations=this.generateQualityRecommendations(e,i),i}assessDimensionQuality(e,i){if(!e.extracted)return{score:0,grade:"F",status:"missing",issues:["维度内容缺失"],strengths:[]};const s={score:e.quality.overall*100,grade:this.calculateGrade(e.quality.overall*100),status:this.determineStatus(e.quality.overall*100),issues:e.issues||[],strengths:[]};return e.quality.completeness>.8&&s.strengths.push("信息完整度高"),e.quality.accuracy>.8&&s.strengths.push("信息准确度高"),e.confidence>.8&&s.strengths.push("提取置信度高"),s}calculateGrade(e){return e>=90?"A":e>=80?"B":e>=70?"C":e>=60?"D":"F"}determineStatus(e){return e>=80?"excellent":e>=70?"good":e>=60?"acceptable":e>=40?"poor":"critical"}calculateQualityMetrics(e){const i={};return Object.keys(this.qualityMetrics).forEach(s=>{const t=this.qualityMetrics[s];i[s]={value:this.calculateMetricValue(e,s),weight:t.weight,description:t.calculation}}),i}calculateMetricValue(e,i){const s=Object.values(e);switch(i){case"completeness":const t=s.length*3;return s.reduce((a,l)=>l.extracted?a+Object.values(l.fields).filter(u=>u&&u.value).length:a,0)/t;case"accuracy":const r=s.reduce((a,l)=>l.extracted?a.concat(Object.values(l.fields).filter(u=>u&&u.value)):a,[]);return r.length===0?0:r.reduce((a,l)=>a+l.confidence,0)/r.length;case"consistency":return s.filter(a=>a.extracted&&a.issues.length===0).length/s.length;case"clarity":return s.reduce((a,l)=>{var u;return a+(((u=l.quality)==null?void 0:u.clarity)||0)},0)/s.length;case"actionability":const o=["D3","D5","D6","D7"];return o.filter(a=>{const l=e[a];return l&&l.extracted&&l.confidence>.6}).length/o.length;default:return 0}}generateQualityRecommendations(e,i){const s=[];return i.overall.score<60&&s.push({priority:"high",category:"整体质量",description:"8D报告整体质量偏低，建议重新审视各维度内容的完整性和准确性",impact:"提升报告整体可信度和实用性"}),Object.keys(i.dimensions).forEach(t=>{const n=i.dimensions[t];if(n.score<70){const r=this.analyzer.reportStructure[t];s.push({priority:n.score<40?"high":"medium",category:`${t} - ${r.name}`,description:this.getDimensionRecommendation(t,n),impact:`提升${r.name}维度质量`})}}),Object.keys(i.metrics).forEach(t=>{const n=i.metrics[t];n.value<.7&&s.push({priority:"medium",category:`质量指标 - ${t}`,description:this.getMetricRecommendation(t,n.value),impact:`提升${t}指标`})}),s.slice(0,10)}getDimensionRecommendation(e,i){let t={D1:"建议补充完整的团队成员信息，包括姓名、角色、联系方式和专业背景",D2:"建议详细描述问题现象，包括具体数据、发生频率、影响范围和客户反馈",D3:"建议明确临时措施的具体内容、实施时间、负责人和验证方法",D4:"建议使用系统性分析方法深入分析根本原因，并提供充分的验证证据",D5:"建议制定详细的永久纠正措施，包括实施计划、时间表和预期效果",D6:"建议补充措施实施的具体进度、验证结果和效果评估",D7:"建议建立系统性的预防措施，包括流程改进和培训计划",D8:"建议详细记录团队贡献和经验总结，建立知识分享机制"}[e]||"建议补充更详细的信息";return i.issues.includes("维度内容缺失")?t=`${e}维度内容完全缺失，`+t:i.issues.length>0&&(t+=`。特别注意：${i.issues.join("、")}`),t}getMetricRecommendation(e,i){return{completeness:"建议补充缺失的必填字段信息，确保每个维度的关键信息完整",accuracy:"建议提高信息的准确性和具体性，避免模糊或不确定的表述",consistency:"建议检查各维度间的信息一致性，确保时间线和责任人等信息匹配",clarity:"建议改善内容的清晰度，使用结构化的表述方式",actionability:"建议增加具体的行动项和可执行的措施"}[e]||"建议改善该质量指标"}generateExtractionReport(e,i,s,t){return{summary:{documentType:"8D质量管理报告",confidence:e.confidence,extractionSuccess:!0,dimensionsProcessed:Object.keys(s).length,overallQuality:t.overall.grade,processingTime:new Date().toISOString()},identification:{is8DReport:e.is8DReport,confidence:e.confidence,suggestedTemplate:e.suggestedTemplate},extraction:{dimensionsExtracted:Object.keys(s).filter(n=>s[n].extracted).length,totalDimensions:Object.keys(s).length,averageConfidence:this.calculateAverageConfidence(s)},quality:{overall:t.overall,metrics:t.metrics,topIssues:this.getTopIssues(s),strengths:this.getStrengths(s)},recommendations:t.recommendations.slice(0,5)}}calculateAverageConfidence(e){const i=Object.values(e).filter(s=>s.extracted);return i.length===0?0:i.reduce((s,t)=>s+t.confidence,0)/i.length}getTopIssues(e){const i=[];return Object.keys(e).forEach(s=>{const t=e[s];t.issues&&t.issues.length>0&&t.issues.forEach(n=>{i.push({dimension:s,issue:n,severity:t.confidence<.5?"high":"medium"})})}),i.slice(0,5)}getStrengths(e){const i=[];return Object.keys(e).forEach(s=>{const t=e[s];if(t.extracted&&t.confidence>.8){const n=this.analyzer.reportStructure[s];i.push({dimension:s,name:n.name,confidence:t.confidence,description:`${n.name}维度信息提取质量高`})}}),i}}const p=new g;export{g as EightDDataExtractor,p as default};
