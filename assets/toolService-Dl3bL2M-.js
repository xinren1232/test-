class y{constructor(){this.searchEngines={serpapi:{baseURL:"https://serpapi.com/search",apiKey:null},duckduckgo:{baseURL:"https://api.duckduckgo.com/",instantAnswer:!0},wikipedia:{baseURL:"https://zh.wikipedia.org/api/rest_v1/",language:"zh"}}}async search(t,e={}){const{engine:r="duckduckgo",limit:a=5,type:s="web"}=e;try{switch(console.log(`ğŸ” å¼€å§‹æœç´¢: "${t}" (å¼•æ“: ${r})`),r){case"duckduckgo":return await this.searchDuckDuckGo(t,a);case"wikipedia":return await this.searchWikipedia(t,a);case"news":return await this.searchNews(t,a);default:return await this.searchDuckDuckGo(t,a)}}catch(n){throw console.error("âŒ æœç´¢å¤±è´¥:",n),n}}async searchDuckDuckGo(t,e=5){try{const r=`https://api.duckduckgo.com/?q=${encodeURIComponent(t)}&format=json&no_html=1&skip_disambig=1`,s=await(await fetch(r)).json(),n={query:t,engine:"duckduckgo",timestamp:new Date().toISOString(),results:[]};return s.AbstractText&&n.results.push({title:s.Heading||"å³æ—¶ç­”æ¡ˆ",snippet:s.AbstractText,url:s.AbstractURL||"",type:"instant_answer"}),s.RelatedTopics&&s.RelatedTopics.length>0&&s.RelatedTopics.slice(0,e-1).forEach(i=>{i.Text&&i.FirstURL&&n.results.push({title:i.Text.split(" - ")[0]||"ç›¸å…³ä¸»é¢˜",snippet:i.Text,url:i.FirstURL,type:"related_topic"})}),n.results.length===0&&n.results.push({title:"æœç´¢å»ºè®®",snippet:`æ²¡æœ‰æ‰¾åˆ°å…³äº"${t}"çš„ç›´æ¥ç­”æ¡ˆï¼Œå»ºè®®å°è¯•æ›´å…·ä½“çš„å…³é”®è¯ã€‚`,url:`https://duckduckgo.com/?q=${encodeURIComponent(t)}`,type:"suggestion"}),console.log(`âœ… DuckDuckGoæœç´¢å®Œæˆï¼Œæ‰¾åˆ° ${n.results.length} ä¸ªç»“æœ`),n}catch(r){throw console.error("âŒ DuckDuckGoæœç´¢å¤±è´¥:",r),new Error(`DuckDuckGoæœç´¢å¤±è´¥: ${r.message}`)}}async searchWikipedia(t,e=3){var r,a,s;try{const n=`https://zh.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(t)}`,i=await fetch(n);if(!i.ok)throw new Error(`Wikipedia APIé”™è¯¯: ${i.status}`);const c=await i.json(),o={query:t,engine:"wikipedia",timestamp:new Date().toISOString(),results:[]};return c.extract&&o.results.push({title:c.title||t,snippet:c.extract,url:((a=(r=c.content_urls)==null?void 0:r.desktop)==null?void 0:a.page)||`https://zh.wikipedia.org/wiki/${encodeURIComponent(t)}`,type:"wikipedia_summary",thumbnail:(s=c.thumbnail)==null?void 0:s.source}),console.log(`âœ… Wikipediaæœç´¢å®Œæˆï¼Œæ‰¾åˆ° ${o.results.length} ä¸ªç»“æœ`),o}catch(n){return console.error("âŒ Wikipediaæœç´¢å¤±è´¥:",n),await this.searchWikipediaSuggestions(t,e)}}async searchWikipediaSuggestions(t,e=3){try{const r=`https://zh.wikipedia.org/w/api.php?action=opensearch&search=${encodeURIComponent(t)}&limit=${e}&format=json&origin=*`,s=await(await fetch(r)).json(),n={query:t,engine:"wikipedia_suggestions",timestamp:new Date().toISOString(),results:[]};if(s&&s.length>=4){const i=s[1],c=s[2],o=s[3];for(let l=0;l<Math.min(i.length,e);l++)n.results.push({title:i[l],snippet:c[l]||"æš‚æ— æè¿°",url:o[l],type:"wikipedia_suggestion"})}return console.log(`âœ… Wikipediaå»ºè®®æœç´¢å®Œæˆï¼Œæ‰¾åˆ° ${n.results.length} ä¸ªç»“æœ`),n}catch(r){throw console.error("âŒ Wikipediaå»ºè®®æœç´¢å¤±è´¥:",r),r}}async searchNews(t,e=5){try{const r={query:t,engine:"news",timestamp:new Date().toISOString(),results:[]};return r.results.push({title:"æ–°é—»æœç´¢åŠŸèƒ½",snippet:`å…³äº"${t}"çš„æ–°é—»æœç´¢åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ã€‚å»ºè®®ä½¿ç”¨å…¶ä»–æœç´¢å¼•æ“è·å–æœ€æ–°ä¿¡æ¯ã€‚`,url:`https://news.google.com/search?q=${encodeURIComponent(t)}`,type:"news_placeholder"}),r}catch(r){throw console.error("âŒ æ–°é—»æœç´¢å¤±è´¥:",r),r}}async getRealTimeInfo(t,e=""){try{switch(console.log(`â° è·å–å®æ—¶ä¿¡æ¯: ${t}`),t){case"time":return this.getCurrentTime();case"weather":return await this.getWeatherInfo(e);case"exchange":return await this.getExchangeRates();default:throw new Error(`ä¸æ”¯æŒçš„å®æ—¶ä¿¡æ¯ç±»å‹: ${t}`)}}catch(r){throw console.error("âŒ è·å–å®æ—¶ä¿¡æ¯å¤±è´¥:",r),r}}getCurrentTime(){const t=new Date;return{type:"time",data:{timestamp:t.toISOString(),local_time:t.toLocaleString("zh-CN"),timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,unix_timestamp:Math.floor(t.getTime()/1e3)}}}async getWeatherInfo(t="åŒ—äº¬"){try{return{type:"weather",data:{city:t,message:"å¤©æ°”ä¿¡æ¯åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œå»ºè®®æŸ¥è¯¢å…·ä½“çš„å¤©æ°”ç½‘ç«™è·å–å‡†ç¡®ä¿¡æ¯ã€‚",suggestion:`https://weather.com/zh-CN/weather/today/l/${encodeURIComponent(t)}`}}}catch(e){throw new Error(`å¤©æ°”ä¿¡æ¯è·å–å¤±è´¥: ${e.message}`)}}async getExchangeRates(){try{const e=await(await fetch("https://api.exchangerate-api.com/v4/latest/USD")).json();return{type:"exchange",data:{base:e.base,date:e.date,rates:{CNY:e.rates.CNY,EUR:e.rates.EUR,JPY:e.rates.JPY,GBP:e.rates.GBP}}}}catch(t){throw new Error(`æ±‡ç‡ä¿¡æ¯è·å–å¤±è´¥: ${t.message}`)}}async smartSearch(t){try{console.log(`ğŸ§  æ™ºèƒ½æœç´¢: "${t}"`);const e=this.analyzeQuery(t),r=[],a=e.engines.map(async n=>{try{return await this.search(t,{engine:n,limit:3})}catch(i){return console.warn(`âš ï¸ ${n}æœç´¢å¤±è´¥:`,i.message),null}});return(await Promise.allSettled(a)).forEach((n,i)=>{n.status==="fulfilled"&&n.value&&r.push(n.value)}),{query:t,strategy:e,timestamp:new Date().toISOString(),sources:r}}catch(e){throw console.error("âŒ æ™ºèƒ½æœç´¢å¤±è´¥:",e),e}}analyzeQuery(t){const e=t.toLowerCase(),r={time:/æ—¶é—´|ç°åœ¨å‡ ç‚¹|å½“å‰æ—¶é—´/,weather:/å¤©æ°”|æ°”æ¸©|ä¸‹é›¨|æ™´å¤©/,news:/æ–°é—»|æœ€æ–°|ä»Šå¤©å‘ç”Ÿ/,wikipedia:/æ˜¯ä»€ä¹ˆ|å®šä¹‰|ä»‹ç»|å†å²/,technical:/æŠ€æœ¯|ç¼–ç¨‹|ä»£ç |ç®—æ³•/},a=[],s=["duckduckgo"];for(const[n,i]of Object.entries(r))i.test(e)&&(a.push(n),n==="wikipedia"?s.push("wikipedia"):n==="news"&&s.push("news"));return{types:a,engines:[...new Set(s)],priority:a[0]||"general"}}}const h=new y;class m{constructor(){this.tools={web_search:{name:"web_search",description:"åœ¨äº’è”ç½‘ä¸Šæœç´¢ä¿¡æ¯",parameters:{query:{type:"string",required:!0,description:"æœç´¢æŸ¥è¯¢"},engine:{type:"string",required:!1,description:"æœç´¢å¼•æ“"}}},get_time:{name:"get_time",description:"è·å–å½“å‰æ—¶é—´",parameters:{}},calculate:{name:"calculate",description:"æ‰§è¡Œæ•°å­¦è®¡ç®—",parameters:{expression:{type:"string",required:!0,description:"æ•°å­¦è¡¨è¾¾å¼"}}},analyze_data:{name:"analyze_data",description:"åˆ†æè´¨é‡ç®¡ç†æ•°æ®",parameters:{data_type:{type:"string",required:!0,description:"æ•°æ®ç±»å‹"},filters:{type:"object",required:!1,description:"è¿‡æ»¤æ¡ä»¶"}}},format_data:{name:"format_data",description:"æ ¼å¼åŒ–æ•°æ®è¾“å‡º",parameters:{data:{type:"object",required:!0,description:"è¦æ ¼å¼åŒ–çš„æ•°æ®"},format:{type:"string",required:!0,description:"è¾“å‡ºæ ¼å¼"}}},create_chart:{name:"create_chart",description:"ç”Ÿæˆæ•°æ®å¯è§†åŒ–å›¾è¡¨",parameters:{data:{type:"array",required:!0,description:"å›¾è¡¨æ•°æ®"},chart_type:{type:"string",required:!0,description:"å›¾è¡¨ç±»å‹"},title:{type:"string",required:!1,description:"å›¾è¡¨æ ‡é¢˜"}}},statistical_analysis:{name:"statistical_analysis",description:"æ‰§è¡Œç»Ÿè®¡åˆ†æ",parameters:{data:{type:"array",required:!0,description:"æ•°æ®æ•°ç»„"},analysis_type:{type:"string",required:!0,description:"åˆ†æç±»å‹"}}},export_data:{name:"export_data",description:"å¯¼å‡ºæ•°æ®ä¸ºå„ç§æ ¼å¼",parameters:{data:{type:"object",required:!0,description:"è¦å¯¼å‡ºçš„æ•°æ®"},format:{type:"string",required:!0,description:"å¯¼å‡ºæ ¼å¼"}}},generate_report:{name:"generate_report",description:"ç”Ÿæˆè´¨é‡åˆ†ææŠ¥å‘Š",parameters:{data_type:{type:"string",required:!0,description:"æ•°æ®ç±»å‹"},template:{type:"string",required:!1,description:"æŠ¥å‘Šæ¨¡æ¿"}}},trend_analysis:{name:"trend_analysis",description:"åˆ†ææ•°æ®è¶‹åŠ¿",parameters:{data:{type:"array",required:!0,description:"æ—¶é—´åºåˆ—æ•°æ®"},period:{type:"string",required:!1,description:"åˆ†æå‘¨æœŸ"}}}}}getAvailableTools(){return Object.values(this.tools)}async executeTool(t,e={}){try{if(console.log(`ğŸ”§ æ‰§è¡Œå·¥å…·: ${t}`,e),!this.tools[t])throw new Error(`æœªçŸ¥å·¥å…·: ${t}`);switch(this.validateParameters(t,e),t){case"web_search":return await this.executeWebSearch(e);case"get_time":return await this.executeGetTime(e);case"calculate":return await this.executeCalculate(e);case"analyze_data":return await this.executeAnalyzeData(e);case"format_data":return await this.executeFormatData(e);case"create_chart":return await this.executeCreateChart(e);case"statistical_analysis":return await this.executeStatisticalAnalysis(e);case"export_data":return await this.executeExportData(e);case"generate_report":return await this.executeGenerateReport(e);case"trend_analysis":return await this.executeTrendAnalysis(e);default:throw new Error(`å·¥å…· ${t} æœªå®ç°`)}}catch(r){throw console.error(`âŒ å·¥å…·æ‰§è¡Œå¤±è´¥ (${t}):`,r),r}}validateParameters(t,e){const r=this.tools[t];for(const[a,s]of Object.entries(r.parameters))if(s.required&&!(a in e))throw new Error(`ç¼ºå°‘å¿…éœ€å‚æ•°: ${a}`)}async executeWebSearch(t){const{query:e,engine:r="duckduckgo"}=t;try{const a=await h.search(e,{engine:r});return{tool:"web_search",success:!0,data:a,summary:`æ‰¾åˆ° ${a.results.length} ä¸ªå…³äº"${e}"çš„æœç´¢ç»“æœ`}}catch(a){return{tool:"web_search",success:!1,error:a.message,summary:`æœç´¢"${e}"æ—¶å‡ºç°é”™è¯¯`}}}async executeGetTime(t){try{const e=h.getCurrentTime();return{tool:"get_time",success:!0,data:e.data,summary:`å½“å‰æ—¶é—´: ${e.data.local_time}`}}catch(e){return{tool:"get_time",success:!1,error:e.message,summary:"è·å–æ—¶é—´ä¿¡æ¯å¤±è´¥"}}}async executeCalculate(t){const{expression:e}=t;try{const r=this.safeEvaluate(e);return{tool:"calculate",success:!0,data:{expression:e,result:r},summary:`${e} = ${r}`}}catch(r){return{tool:"calculate",success:!1,error:r.message,summary:`è®¡ç®—"${e}"æ—¶å‡ºç°é”™è¯¯`}}}safeEvaluate(t){const e=t.replace(/[^0-9+\-*/().\s]/g,"");if(e!==t)throw new Error("è¡¨è¾¾å¼åŒ…å«ä¸å®‰å…¨çš„å­—ç¬¦");try{const r=Function(`"use strict"; return (${e})`)();if(typeof r!="number"||!isFinite(r))throw new Error("è®¡ç®—ç»“æœæ— æ•ˆ");return r}catch{throw new Error("è¡¨è¾¾å¼è®¡ç®—å¤±è´¥")}}async executeAnalyzeData(t){const{data_type:e,filters:r={}}=t;try{const a=this.getLocalStorageData(e);if(!a||a.length===0)return{tool:"analyze_data",success:!1,error:"æœªæ‰¾åˆ°æ•°æ®",summary:`æœªæ‰¾åˆ°${e}ç±»å‹çš„æ•°æ®`};const s=this.applyFilters(a,r),n=this.performDataAnalysis(s,e);return{tool:"analyze_data",success:!0,data:{data_type:e,total_records:a.length,filtered_records:s.length,analysis:n},summary:`åˆ†æäº† ${s.length} æ¡${e}æ•°æ®`}}catch(a){return{tool:"analyze_data",success:!1,error:a.message,summary:`åˆ†æ${e}æ•°æ®æ—¶å‡ºç°é”™è¯¯`}}}getLocalStorageData(t){const r={inventory:"unified_inventory_data",production:"unified_factory_data",testing:"unified_lab_data",batch:"unified_batch_data"}[t];if(!r)throw new Error(`ä¸æ”¯æŒçš„æ•°æ®ç±»å‹: ${t}`);const a=localStorage.getItem(r);return a?JSON.parse(a):[]}applyFilters(t,e){return t.filter(r=>{for(const[a,s]of Object.entries(e))if(r[a]!==s)return!1;return!0})}performDataAnalysis(t,e){const r={total_count:t.length,summary:{}};if(t.length===0)return r;switch(e){case"inventory":r.summary=this.analyzeInventoryData(t);break;case"production":r.summary=this.analyzeProductionData(t);break;case"testing":r.summary=this.analyzeTestingData(t);break;default:r.summary={message:"åŸºç¡€ç»Ÿè®¡åˆ†æå®Œæˆ"}}return r}analyzeInventoryData(t){const e={},r={};let a=0;return t.forEach(s=>{e[s.status]=(e[s.status]||0)+1,r[s.factory]=(r[s.factory]||0)+1,a+=parseInt(s.quantity)||0}),{status_distribution:e,factory_distribution:r,total_quantity:a,average_quantity:Math.round(a/t.length)}}analyzeProductionData(t){let e=0;const r={};return t.forEach(a=>{e+=parseFloat(a.defectRate)||0,a.defectPhenomena&&(r[a.defectPhenomena]=(r[a.defectPhenomena]||0)+1)}),{average_defect_rate:(e/t.length).toFixed(2)+"%",defect_types:r,total_batches:t.length}}analyzeTestingData(t){const e={},r={};t.forEach(s=>{e[s.testResult]=(e[s.testResult]||0)+1,s.defectPhenomena&&(r[s.defectPhenomena]=(r[s.defectPhenomena]||0)+1)});const a=((e.PASS||0)/t.length*100).toFixed(1);return{test_results:e,pass_rate:a+"%",defect_types:r}}async executeFormatData(t){const{data:e,format:r}=t;try{let a;switch(r){case"table":a=this.formatAsTable(e);break;case"list":a=this.formatAsList(e);break;case"summary":a=this.formatAsSummary(e);break;default:a=JSON.stringify(e,null,2)}return{tool:"format_data",success:!0,data:{original_data:e,formatted_data:a,format:r},summary:`æ•°æ®å·²æ ¼å¼åŒ–ä¸º${r}æ ¼å¼`}}catch(a){return{tool:"format_data",success:!1,error:a.message,summary:"æ•°æ®æ ¼å¼åŒ–å¤±è´¥"}}}formatAsTable(t){if(!Array.isArray(t)||t.length===0)return"æ— æ•°æ®";const e=Object.keys(t[0]);let r="| "+e.join(" | ")+` |
`;return r+="| "+e.map(()=>"---").join(" | ")+` |
`,t.forEach(a=>{r+="| "+e.map(s=>a[s]||"").join(" | ")+` |
`}),r}formatAsList(t){return Array.isArray(t)?t.map((e,r)=>`${r+1}. ${JSON.stringify(e)}`).join(`
`):Object.entries(t).map(([e,r])=>`â€¢ ${e}: ${r}`).join(`
`)}formatAsSummary(t){if(Array.isArray(t))return`æ•°æ®æ‘˜è¦ï¼šå…± ${t.length} æ¡è®°å½•`;if(typeof t=="object"){const e=Object.keys(t);return`å¯¹è±¡æ‘˜è¦ï¼šåŒ…å« ${e.length} ä¸ªå­—æ®µ (${e.join(", ")})`}else return`æ•°æ®ç±»å‹ï¼š${typeof t}ï¼Œå€¼ï¼š${t}`}async executeFormatData(t){const{data:e,format:r}=t;switch(r){case"table":return{type:"table",data:Array.isArray(e)?e:[e]};case"json":return{type:"json",data:JSON.stringify(e,null,2)};default:return{type:"text",data:String(e)}}}async executeCreateChart(t){const{data:e,chart_type:r,title:a}=t;return{type:"chart",chart_type:r,title:a||"æ•°æ®å›¾è¡¨",data:e,config:{responsive:!0,plugins:{legend:{position:"top"},title:{display:!0,text:a||"æ•°æ®å›¾è¡¨"}}}}}async executeStatisticalAnalysis(t){const{data:e,analysis_type:r}=t;if(!Array.isArray(e)||e.length===0)return{type:"error",message:"æ•°æ®ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®"};const a=e.filter(s=>typeof s=="number");switch(r){case"basic":const s=a.reduce((u,p)=>u+p,0),n=s/a.length,i=Math.max(...a),c=Math.min(...a);return{type:"analysis",analysis_type:"basic",results:{count:a.length,sum:s.toFixed(2),average:n.toFixed(2),maximum:i,minimum:c,range:(i-c).toFixed(2)}};case"distribution":const o=[...a].sort((u,p)=>u-p);return{type:"analysis",analysis_type:"distribution",results:{median:(o.length%2===0?(o[o.length/2-1]+o[o.length/2])/2:o[Math.floor(o.length/2)]).toFixed(2),q1:o[Math.floor(o.length*.25)],q3:o[Math.floor(o.length*.75)],distribution:this.calculateDistribution(a)}};default:return{type:"error",message:"ä¸æ”¯æŒçš„åˆ†æç±»å‹"}}}calculateDistribution(t){const r=Math.min(...t),s=(Math.max(...t)-r)/5,n=new Array(5).fill(0);return t.forEach(i=>{const c=Math.min(Math.floor((i-r)/s),4);n[c]++}),n.map((i,c)=>({range:`${(r+c*s).toFixed(1)}-${(r+(c+1)*s).toFixed(1)}`,count:i}))}async executeExportData(t){const{data:e,format:r}=t;switch(r){case"csv":return{type:"export",format:"csv",filename:`export_${Date.now()}.csv`,content:this.convertToCSV(e)};case"excel":return{type:"export",format:"excel",filename:`export_${Date.now()}.xlsx`,message:"Excelå¯¼å‡ºåŠŸèƒ½éœ€è¦åç«¯æ”¯æŒ"};default:return{type:"export",format:"json",filename:`export_${Date.now()}.json`,content:JSON.stringify(e,null,2)}}}convertToCSV(t){if(!Array.isArray(t)||t.length===0)return"";const e=Object.keys(t[0]);return[e.join(","),...t.map(a=>e.map(s=>a[s]||"").join(","))].join(`
`)}async executeGenerateReport(t){const{data_type:e,template:r}=t;return{type:"report",data_type:e,template:r||"standard",sections:[{title:"æ•°æ®æ¦‚è§ˆ",content:"åŸºç¡€ç»Ÿè®¡ä¿¡æ¯"},{title:"è´¨é‡åˆ†æ",content:"è´¨é‡æŒ‡æ ‡åˆ†æ"},{title:"è¶‹åŠ¿åˆ†æ",content:"æ—¶é—´è¶‹åŠ¿åˆ†æ"},{title:"å»ºè®®æªæ–½",content:"æ”¹è¿›å»ºè®®"}],generated_at:new Date().toISOString()}}async executeTrendAnalysis(t){const{data:e,period:r}=t;return!Array.isArray(e)||e.length===0?{type:"error",message:"æ•°æ®ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®"}:{type:"trend",period:r||"daily",analysis:{trend_direction:this.calculateTrendDirection(e),volatility:this.calculateVolatility(e),seasonal_patterns:this.detectSeasonalPatterns(e),forecast:this.generateSimpleForecast(e)}}}calculateTrendDirection(t){if(t.length<2)return"insufficient_data";const e=t.slice(0,Math.floor(t.length/2)),r=t.slice(Math.floor(t.length/2)),a=e.reduce((n,i)=>n+(typeof i=="number"?i:0),0)/e.length,s=r.reduce((n,i)=>n+(typeof i=="number"?i:0),0)/r.length;return s>a*1.05?"increasing":s<a*.95?"decreasing":"stable"}calculateVolatility(t){const e=t.filter(s=>typeof s=="number");if(e.length<2)return 0;const r=e.reduce((s,n)=>s+n,0)/e.length,a=e.reduce((s,n)=>s+Math.pow(n-r,2),0)/e.length;return Math.sqrt(a)}detectSeasonalPatterns(t){return{detected:!1,pattern:"none",confidence:0}}generateSimpleForecast(t){const e=t.filter(n=>typeof n=="number");if(e.length<3)return[];const r=e.slice(-3),a=(r[r.length-1]-r[0])/(r.length-1),s=r[r.length-1];return[{period:"next_1",value:(s+a).toFixed(2)},{period:"next_2",value:(s+a*2).toFixed(2)},{period:"next_3",value:(s+a*3).toFixed(2)}]}}const g=new m;export{g as default,g as toolService};
