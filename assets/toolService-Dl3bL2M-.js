class y{constructor(){this.searchEngines={serpapi:{baseURL:"https://serpapi.com/search",apiKey:null},duckduckgo:{baseURL:"https://api.duckduckgo.com/",instantAnswer:!0},wikipedia:{baseURL:"https://zh.wikipedia.org/api/rest_v1/",language:"zh"}}}async search(t,e={}){const{engine:r="duckduckgo",limit:a=5,type:s="web"}=e;try{switch(console.log(`🔍 开始搜索: "${t}" (引擎: ${r})`),r){case"duckduckgo":return await this.searchDuckDuckGo(t,a);case"wikipedia":return await this.searchWikipedia(t,a);case"news":return await this.searchNews(t,a);default:return await this.searchDuckDuckGo(t,a)}}catch(n){throw console.error("❌ 搜索失败:",n),n}}async searchDuckDuckGo(t,e=5){try{const r=`https://api.duckduckgo.com/?q=${encodeURIComponent(t)}&format=json&no_html=1&skip_disambig=1`,s=await(await fetch(r)).json(),n={query:t,engine:"duckduckgo",timestamp:new Date().toISOString(),results:[]};return s.AbstractText&&n.results.push({title:s.Heading||"即时答案",snippet:s.AbstractText,url:s.AbstractURL||"",type:"instant_answer"}),s.RelatedTopics&&s.RelatedTopics.length>0&&s.RelatedTopics.slice(0,e-1).forEach(i=>{i.Text&&i.FirstURL&&n.results.push({title:i.Text.split(" - ")[0]||"相关主题",snippet:i.Text,url:i.FirstURL,type:"related_topic"})}),n.results.length===0&&n.results.push({title:"搜索建议",snippet:`没有找到关于"${t}"的直接答案，建议尝试更具体的关键词。`,url:`https://duckduckgo.com/?q=${encodeURIComponent(t)}`,type:"suggestion"}),console.log(`✅ DuckDuckGo搜索完成，找到 ${n.results.length} 个结果`),n}catch(r){throw console.error("❌ DuckDuckGo搜索失败:",r),new Error(`DuckDuckGo搜索失败: ${r.message}`)}}async searchWikipedia(t,e=3){var r,a,s;try{const n=`https://zh.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(t)}`,i=await fetch(n);if(!i.ok)throw new Error(`Wikipedia API错误: ${i.status}`);const c=await i.json(),o={query:t,engine:"wikipedia",timestamp:new Date().toISOString(),results:[]};return c.extract&&o.results.push({title:c.title||t,snippet:c.extract,url:((a=(r=c.content_urls)==null?void 0:r.desktop)==null?void 0:a.page)||`https://zh.wikipedia.org/wiki/${encodeURIComponent(t)}`,type:"wikipedia_summary",thumbnail:(s=c.thumbnail)==null?void 0:s.source}),console.log(`✅ Wikipedia搜索完成，找到 ${o.results.length} 个结果`),o}catch(n){return console.error("❌ Wikipedia搜索失败:",n),await this.searchWikipediaSuggestions(t,e)}}async searchWikipediaSuggestions(t,e=3){try{const r=`https://zh.wikipedia.org/w/api.php?action=opensearch&search=${encodeURIComponent(t)}&limit=${e}&format=json&origin=*`,s=await(await fetch(r)).json(),n={query:t,engine:"wikipedia_suggestions",timestamp:new Date().toISOString(),results:[]};if(s&&s.length>=4){const i=s[1],c=s[2],o=s[3];for(let l=0;l<Math.min(i.length,e);l++)n.results.push({title:i[l],snippet:c[l]||"暂无描述",url:o[l],type:"wikipedia_suggestion"})}return console.log(`✅ Wikipedia建议搜索完成，找到 ${n.results.length} 个结果`),n}catch(r){throw console.error("❌ Wikipedia建议搜索失败:",r),r}}async searchNews(t,e=5){try{const r={query:t,engine:"news",timestamp:new Date().toISOString(),results:[]};return r.results.push({title:"新闻搜索功能",snippet:`关于"${t}"的新闻搜索功能正在开发中。建议使用其他搜索引擎获取最新信息。`,url:`https://news.google.com/search?q=${encodeURIComponent(t)}`,type:"news_placeholder"}),r}catch(r){throw console.error("❌ 新闻搜索失败:",r),r}}async getRealTimeInfo(t,e=""){try{switch(console.log(`⏰ 获取实时信息: ${t}`),t){case"time":return this.getCurrentTime();case"weather":return await this.getWeatherInfo(e);case"exchange":return await this.getExchangeRates();default:throw new Error(`不支持的实时信息类型: ${t}`)}}catch(r){throw console.error("❌ 获取实时信息失败:",r),r}}getCurrentTime(){const t=new Date;return{type:"time",data:{timestamp:t.toISOString(),local_time:t.toLocaleString("zh-CN"),timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,unix_timestamp:Math.floor(t.getTime()/1e3)}}}async getWeatherInfo(t="北京"){try{return{type:"weather",data:{city:t,message:"天气信息功能正在开发中，建议查询具体的天气网站获取准确信息。",suggestion:`https://weather.com/zh-CN/weather/today/l/${encodeURIComponent(t)}`}}}catch(e){throw new Error(`天气信息获取失败: ${e.message}`)}}async getExchangeRates(){try{const e=await(await fetch("https://api.exchangerate-api.com/v4/latest/USD")).json();return{type:"exchange",data:{base:e.base,date:e.date,rates:{CNY:e.rates.CNY,EUR:e.rates.EUR,JPY:e.rates.JPY,GBP:e.rates.GBP}}}}catch(t){throw new Error(`汇率信息获取失败: ${t.message}`)}}async smartSearch(t){try{console.log(`🧠 智能搜索: "${t}"`);const e=this.analyzeQuery(t),r=[],a=e.engines.map(async n=>{try{return await this.search(t,{engine:n,limit:3})}catch(i){return console.warn(`⚠️ ${n}搜索失败:`,i.message),null}});return(await Promise.allSettled(a)).forEach((n,i)=>{n.status==="fulfilled"&&n.value&&r.push(n.value)}),{query:t,strategy:e,timestamp:new Date().toISOString(),sources:r}}catch(e){throw console.error("❌ 智能搜索失败:",e),e}}analyzeQuery(t){const e=t.toLowerCase(),r={time:/时间|现在几点|当前时间/,weather:/天气|气温|下雨|晴天/,news:/新闻|最新|今天发生/,wikipedia:/是什么|定义|介绍|历史/,technical:/技术|编程|代码|算法/},a=[],s=["duckduckgo"];for(const[n,i]of Object.entries(r))i.test(e)&&(a.push(n),n==="wikipedia"?s.push("wikipedia"):n==="news"&&s.push("news"));return{types:a,engines:[...new Set(s)],priority:a[0]||"general"}}}const h=new y;class m{constructor(){this.tools={web_search:{name:"web_search",description:"在互联网上搜索信息",parameters:{query:{type:"string",required:!0,description:"搜索查询"},engine:{type:"string",required:!1,description:"搜索引擎"}}},get_time:{name:"get_time",description:"获取当前时间",parameters:{}},calculate:{name:"calculate",description:"执行数学计算",parameters:{expression:{type:"string",required:!0,description:"数学表达式"}}},analyze_data:{name:"analyze_data",description:"分析质量管理数据",parameters:{data_type:{type:"string",required:!0,description:"数据类型"},filters:{type:"object",required:!1,description:"过滤条件"}}},format_data:{name:"format_data",description:"格式化数据输出",parameters:{data:{type:"object",required:!0,description:"要格式化的数据"},format:{type:"string",required:!0,description:"输出格式"}}},create_chart:{name:"create_chart",description:"生成数据可视化图表",parameters:{data:{type:"array",required:!0,description:"图表数据"},chart_type:{type:"string",required:!0,description:"图表类型"},title:{type:"string",required:!1,description:"图表标题"}}},statistical_analysis:{name:"statistical_analysis",description:"执行统计分析",parameters:{data:{type:"array",required:!0,description:"数据数组"},analysis_type:{type:"string",required:!0,description:"分析类型"}}},export_data:{name:"export_data",description:"导出数据为各种格式",parameters:{data:{type:"object",required:!0,description:"要导出的数据"},format:{type:"string",required:!0,description:"导出格式"}}},generate_report:{name:"generate_report",description:"生成质量分析报告",parameters:{data_type:{type:"string",required:!0,description:"数据类型"},template:{type:"string",required:!1,description:"报告模板"}}},trend_analysis:{name:"trend_analysis",description:"分析数据趋势",parameters:{data:{type:"array",required:!0,description:"时间序列数据"},period:{type:"string",required:!1,description:"分析周期"}}}}}getAvailableTools(){return Object.values(this.tools)}async executeTool(t,e={}){try{if(console.log(`🔧 执行工具: ${t}`,e),!this.tools[t])throw new Error(`未知工具: ${t}`);switch(this.validateParameters(t,e),t){case"web_search":return await this.executeWebSearch(e);case"get_time":return await this.executeGetTime(e);case"calculate":return await this.executeCalculate(e);case"analyze_data":return await this.executeAnalyzeData(e);case"format_data":return await this.executeFormatData(e);case"create_chart":return await this.executeCreateChart(e);case"statistical_analysis":return await this.executeStatisticalAnalysis(e);case"export_data":return await this.executeExportData(e);case"generate_report":return await this.executeGenerateReport(e);case"trend_analysis":return await this.executeTrendAnalysis(e);default:throw new Error(`工具 ${t} 未实现`)}}catch(r){throw console.error(`❌ 工具执行失败 (${t}):`,r),r}}validateParameters(t,e){const r=this.tools[t];for(const[a,s]of Object.entries(r.parameters))if(s.required&&!(a in e))throw new Error(`缺少必需参数: ${a}`)}async executeWebSearch(t){const{query:e,engine:r="duckduckgo"}=t;try{const a=await h.search(e,{engine:r});return{tool:"web_search",success:!0,data:a,summary:`找到 ${a.results.length} 个关于"${e}"的搜索结果`}}catch(a){return{tool:"web_search",success:!1,error:a.message,summary:`搜索"${e}"时出现错误`}}}async executeGetTime(t){try{const e=h.getCurrentTime();return{tool:"get_time",success:!0,data:e.data,summary:`当前时间: ${e.data.local_time}`}}catch(e){return{tool:"get_time",success:!1,error:e.message,summary:"获取时间信息失败"}}}async executeCalculate(t){const{expression:e}=t;try{const r=this.safeEvaluate(e);return{tool:"calculate",success:!0,data:{expression:e,result:r},summary:`${e} = ${r}`}}catch(r){return{tool:"calculate",success:!1,error:r.message,summary:`计算"${e}"时出现错误`}}}safeEvaluate(t){const e=t.replace(/[^0-9+\-*/().\s]/g,"");if(e!==t)throw new Error("表达式包含不安全的字符");try{const r=Function(`"use strict"; return (${e})`)();if(typeof r!="number"||!isFinite(r))throw new Error("计算结果无效");return r}catch{throw new Error("表达式计算失败")}}async executeAnalyzeData(t){const{data_type:e,filters:r={}}=t;try{const a=this.getLocalStorageData(e);if(!a||a.length===0)return{tool:"analyze_data",success:!1,error:"未找到数据",summary:`未找到${e}类型的数据`};const s=this.applyFilters(a,r),n=this.performDataAnalysis(s,e);return{tool:"analyze_data",success:!0,data:{data_type:e,total_records:a.length,filtered_records:s.length,analysis:n},summary:`分析了 ${s.length} 条${e}数据`}}catch(a){return{tool:"analyze_data",success:!1,error:a.message,summary:`分析${e}数据时出现错误`}}}getLocalStorageData(t){const r={inventory:"unified_inventory_data",production:"unified_factory_data",testing:"unified_lab_data",batch:"unified_batch_data"}[t];if(!r)throw new Error(`不支持的数据类型: ${t}`);const a=localStorage.getItem(r);return a?JSON.parse(a):[]}applyFilters(t,e){return t.filter(r=>{for(const[a,s]of Object.entries(e))if(r[a]!==s)return!1;return!0})}performDataAnalysis(t,e){const r={total_count:t.length,summary:{}};if(t.length===0)return r;switch(e){case"inventory":r.summary=this.analyzeInventoryData(t);break;case"production":r.summary=this.analyzeProductionData(t);break;case"testing":r.summary=this.analyzeTestingData(t);break;default:r.summary={message:"基础统计分析完成"}}return r}analyzeInventoryData(t){const e={},r={};let a=0;return t.forEach(s=>{e[s.status]=(e[s.status]||0)+1,r[s.factory]=(r[s.factory]||0)+1,a+=parseInt(s.quantity)||0}),{status_distribution:e,factory_distribution:r,total_quantity:a,average_quantity:Math.round(a/t.length)}}analyzeProductionData(t){let e=0;const r={};return t.forEach(a=>{e+=parseFloat(a.defectRate)||0,a.defectPhenomena&&(r[a.defectPhenomena]=(r[a.defectPhenomena]||0)+1)}),{average_defect_rate:(e/t.length).toFixed(2)+"%",defect_types:r,total_batches:t.length}}analyzeTestingData(t){const e={},r={};t.forEach(s=>{e[s.testResult]=(e[s.testResult]||0)+1,s.defectPhenomena&&(r[s.defectPhenomena]=(r[s.defectPhenomena]||0)+1)});const a=((e.PASS||0)/t.length*100).toFixed(1);return{test_results:e,pass_rate:a+"%",defect_types:r}}async executeFormatData(t){const{data:e,format:r}=t;try{let a;switch(r){case"table":a=this.formatAsTable(e);break;case"list":a=this.formatAsList(e);break;case"summary":a=this.formatAsSummary(e);break;default:a=JSON.stringify(e,null,2)}return{tool:"format_data",success:!0,data:{original_data:e,formatted_data:a,format:r},summary:`数据已格式化为${r}格式`}}catch(a){return{tool:"format_data",success:!1,error:a.message,summary:"数据格式化失败"}}}formatAsTable(t){if(!Array.isArray(t)||t.length===0)return"无数据";const e=Object.keys(t[0]);let r="| "+e.join(" | ")+` |
`;return r+="| "+e.map(()=>"---").join(" | ")+` |
`,t.forEach(a=>{r+="| "+e.map(s=>a[s]||"").join(" | ")+` |
`}),r}formatAsList(t){return Array.isArray(t)?t.map((e,r)=>`${r+1}. ${JSON.stringify(e)}`).join(`
`):Object.entries(t).map(([e,r])=>`• ${e}: ${r}`).join(`
`)}formatAsSummary(t){if(Array.isArray(t))return`数据摘要：共 ${t.length} 条记录`;if(typeof t=="object"){const e=Object.keys(t);return`对象摘要：包含 ${e.length} 个字段 (${e.join(", ")})`}else return`数据类型：${typeof t}，值：${t}`}async executeFormatData(t){const{data:e,format:r}=t;switch(r){case"table":return{type:"table",data:Array.isArray(e)?e:[e]};case"json":return{type:"json",data:JSON.stringify(e,null,2)};default:return{type:"text",data:String(e)}}}async executeCreateChart(t){const{data:e,chart_type:r,title:a}=t;return{type:"chart",chart_type:r,title:a||"数据图表",data:e,config:{responsive:!0,plugins:{legend:{position:"top"},title:{display:!0,text:a||"数据图表"}}}}}async executeStatisticalAnalysis(t){const{data:e,analysis_type:r}=t;if(!Array.isArray(e)||e.length===0)return{type:"error",message:"数据为空或格式不正确"};const a=e.filter(s=>typeof s=="number");switch(r){case"basic":const s=a.reduce((u,p)=>u+p,0),n=s/a.length,i=Math.max(...a),c=Math.min(...a);return{type:"analysis",analysis_type:"basic",results:{count:a.length,sum:s.toFixed(2),average:n.toFixed(2),maximum:i,minimum:c,range:(i-c).toFixed(2)}};case"distribution":const o=[...a].sort((u,p)=>u-p);return{type:"analysis",analysis_type:"distribution",results:{median:(o.length%2===0?(o[o.length/2-1]+o[o.length/2])/2:o[Math.floor(o.length/2)]).toFixed(2),q1:o[Math.floor(o.length*.25)],q3:o[Math.floor(o.length*.75)],distribution:this.calculateDistribution(a)}};default:return{type:"error",message:"不支持的分析类型"}}}calculateDistribution(t){const r=Math.min(...t),s=(Math.max(...t)-r)/5,n=new Array(5).fill(0);return t.forEach(i=>{const c=Math.min(Math.floor((i-r)/s),4);n[c]++}),n.map((i,c)=>({range:`${(r+c*s).toFixed(1)}-${(r+(c+1)*s).toFixed(1)}`,count:i}))}async executeExportData(t){const{data:e,format:r}=t;switch(r){case"csv":return{type:"export",format:"csv",filename:`export_${Date.now()}.csv`,content:this.convertToCSV(e)};case"excel":return{type:"export",format:"excel",filename:`export_${Date.now()}.xlsx`,message:"Excel导出功能需要后端支持"};default:return{type:"export",format:"json",filename:`export_${Date.now()}.json`,content:JSON.stringify(e,null,2)}}}convertToCSV(t){if(!Array.isArray(t)||t.length===0)return"";const e=Object.keys(t[0]);return[e.join(","),...t.map(a=>e.map(s=>a[s]||"").join(","))].join(`
`)}async executeGenerateReport(t){const{data_type:e,template:r}=t;return{type:"report",data_type:e,template:r||"standard",sections:[{title:"数据概览",content:"基础统计信息"},{title:"质量分析",content:"质量指标分析"},{title:"趋势分析",content:"时间趋势分析"},{title:"建议措施",content:"改进建议"}],generated_at:new Date().toISOString()}}async executeTrendAnalysis(t){const{data:e,period:r}=t;return!Array.isArray(e)||e.length===0?{type:"error",message:"数据为空或格式不正确"}:{type:"trend",period:r||"daily",analysis:{trend_direction:this.calculateTrendDirection(e),volatility:this.calculateVolatility(e),seasonal_patterns:this.detectSeasonalPatterns(e),forecast:this.generateSimpleForecast(e)}}}calculateTrendDirection(t){if(t.length<2)return"insufficient_data";const e=t.slice(0,Math.floor(t.length/2)),r=t.slice(Math.floor(t.length/2)),a=e.reduce((n,i)=>n+(typeof i=="number"?i:0),0)/e.length,s=r.reduce((n,i)=>n+(typeof i=="number"?i:0),0)/r.length;return s>a*1.05?"increasing":s<a*.95?"decreasing":"stable"}calculateVolatility(t){const e=t.filter(s=>typeof s=="number");if(e.length<2)return 0;const r=e.reduce((s,n)=>s+n,0)/e.length,a=e.reduce((s,n)=>s+Math.pow(n-r,2),0)/e.length;return Math.sqrt(a)}detectSeasonalPatterns(t){return{detected:!1,pattern:"none",confidence:0}}generateSimpleForecast(t){const e=t.filter(n=>typeof n=="number");if(e.length<3)return[];const r=e.slice(-3),a=(r[r.length-1]-r[0])/(r.length-1),s=r[r.length-1];return[{period:"next_1",value:(s+a).toFixed(2)},{period:"next_2",value:(s+a*2).toFixed(2)},{period:"next_3",value:(s+a*3).toFixed(2)}]}}const g=new m;export{g as default,g as toolService};
