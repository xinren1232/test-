# 数据生成规则修复总结

## 🔍 发现的问题

### 1. **数据量规则不符合要求**
- **原问题**: 每个批次2-3条测试记录，3-5条生产记录
- **用户要求**: 每个批次3条测试记录，8条生产记录
- **修复状态**: ✅ 已修复

### 2. **时间交错逻辑缺失**
- **原问题**: 测试和生产时间是独立随机生成的
- **用户要求**: 测试/生产时间应该交错，库存入库时间保持不变
- **修复状态**: ✅ 已修复

### 3. **数据规则冲突**
- **原问题**: `SystemDataUpdater.js` 和 `data_generator.js` 中的规则不一致
- **修复状态**: ✅ 已统一

### 4. **不存在的函数调用**
- **原问题**: `FactoryView.vue` 中调用了不存在的 `renderQualityChart()` 函数
- **修复状态**: ✅ 已删除

## 🛠️ 具体修复内容

### 1. 修改 `data_generator.js`

#### 测试记录数量修复
```javascript
// 修改前
const recordCount = Math.floor(Math.random() * 2) + 2; // 2-3条记录

// 修改后  
const recordCount = 3; // 固定3条记录
```

#### 生产记录数量修复
```javascript
// 修改前
const recordCount = Math.floor(Math.random() * 3) + 3; // 3-5条记录

// 修改后
const recordCount = 8; // 固定8条记录
```

#### 新增时间交错逻辑
```javascript
/**
 * 生成交错的时间序列
 * @param {Date} baseDate - 基准日期（库存入库时间）
 * @param {number} testCount - 测试记录数量
 * @param {number} productionCount - 生产记录数量
 * @returns {Object} 包含测试和生产时间的对象
 */
function generateInterleavedTimeSequence(baseDate, testCount, productionCount) {
  // 实现时间交错逻辑
  // 在60天时间跨度内，测试和生产时间交替分配
}
```

### 2. 修改 `SystemDataUpdater.js`

#### 统一数据规则
```javascript
// 测试记录规则
TEST_RECORD_RULES: {
  MIN_PER_BATCH: 3,
  MAX_PER_BATCH: 3,
  PASS_RATE: 0.92,
  FORMAT: '每个物料批次需要3条历史测试记录'
},

// 新增生产记录规则
PRODUCTION_RECORD_RULES: {
  MIN_PER_BATCH: 8,
  MAX_PER_BATCH: 8,
  FORMAT: '每个物料批次需要8条历史生产记录'
}
```

### 3. 修改 `FactoryView.vue`

#### 删除不存在的函数调用
```javascript
// 修改前
nextTick(() => {
  renderFactoryChart();
  renderQualityChart(); // ❌ 函数不存在
});

// 修改后
nextTick(() => {
  renderFactoryChart();
});
```

#### 优化数据生成和保存逻辑
```javascript
// 使用统一数据服务保存数据
unifiedDataService.saveInventoryData(dataset.inventory, true);
unifiedDataService.saveLabData(dataset.inspection, true);
unifiedDataService.saveFactoryData(dataset.production, true);
```

#### 添加自动数据生成
```javascript
// 在页面初始化时，如果没有数据则自动生成
if (!materials.value || materials.value.length === 0) {
  // 尝试生成数据
  if (typeof window.generateCompleteDataset === 'function') {
    const dataset = window.generateCompleteDataset();
    // 保存数据...
  }
}
```

## 📊 数据生成规则详细说明

### 时间交错逻辑
1. **基准时间**: 库存入库时间保持不变
2. **时间跨度**: 入库后60天内
3. **交错方式**: 
   - 在60天内随机选择时间槽位
   - 测试和生产时间交替分配
   - 确保测试时间和生产时间不重叠

### 数据量规则
- **库存数据**: 100条（每个物料一条库存记录）
- **测试数据**: 300条（每个批次3条，100个批次）
- **生产数据**: 800条（每个批次8条，100个批次）

### 字段完整性
- **批次号**: 6位数字格式（100000-999999）
- **物料编码**: 符合物料前缀规则
- **时间字段**: ISO格式，确保逻辑正确性
- **项目-基线关系**: 符合业务规则映射

## 🎯 验证方法

### 1. 浏览器控制台验证
```javascript
// 在浏览器控制台中运行
const dataset = window.generateCompleteDataset();
console.log('数据统计:', {
  inventory: dataset.inventory.length,
  inspection: dataset.inspection.length, 
  production: dataset.production.length
});

// 检查第一个批次的记录数量
const firstBatch = dataset.inventory[0].batch_code;
const testCount = dataset.inspection.filter(item => item.batch_code === firstBatch).length;
const prodCount = dataset.production.filter(item => item.batch_code === firstBatch).length;
console.log(`批次 ${firstBatch}: 测试${testCount}条, 生产${prodCount}条`);
```

### 2. 页面功能验证
1. 访问 http://localhost:5173/factory
2. 点击"刷新数据"按钮
3. 检查控制台输出的数据统计
4. 验证表格中显示的数据数量

## 🚀 下一步建议

1. **测试验证**: 在浏览器中测试数据生成功能
2. **性能优化**: 如果数据量过大，考虑分批加载
3. **数据持久化**: 确保生成的数据正确保存到localStorage
4. **错误处理**: 添加更完善的错误处理和用户提示

## 📝 注意事项

1. **模块兼容性**: 确保所有导入的模块路径正确
2. **浏览器兼容性**: 时间处理逻辑在不同浏览器中的表现
3. **数据一致性**: 确保批次号在所有数据类型中保持一致
4. **内存使用**: 大量数据生成时注意内存占用

---

**修复完成时间**: 2025-07-01  
**修复范围**: 数据生成规则、时间逻辑、函数调用、数据保存  
**验证状态**: 待浏览器测试确认
