import mysql from 'mysql2/promise';

const dbConfig = {
  host: 'localhost',
  user: 'root',
  password: 'Zxylsy.99',
  database: 'iqe_inspection'
};

async function cleanDuplicateUnreasonableRules() {
  const connection = await mysql.createConnection(dbConfig);
  
  try {
    console.log('ğŸ§¹ æ¸…ç†é‡å¤å’Œä¸åˆç†çš„è§„åˆ™...\n');
    
    // è·å–æ‰€æœ‰è§„åˆ™
    const [allRules] = await connection.execute(
      'SELECT id, intent_name, action_target, status FROM nlp_intent_rules ORDER BY intent_name'
    );
    
    console.log(`ğŸ“‹ å½“å‰æ•°æ®åº“ä¸­å…±æœ‰ ${allRules.length} æ¡è§„åˆ™\n`);
    
    // å®šä¹‰è¦åˆ é™¤çš„é‡å¤å’Œä¸åˆç†è§„åˆ™
    const rulesToDelete = [
      // 1. é‡å¤çš„è§„åˆ™ï¼ˆä¿ç•™ä¼˜åŒ–ç‰ˆæœ¬ï¼Œåˆ é™¤åŸç‰ˆæœ¬ï¼‰
      'ç‰©æ–™åº“å­˜ä¿¡æ¯æŸ¥è¯¢', // æœ‰ä¼˜åŒ–ç‰ˆæœ¬ï¼šç‰©æ–™åº“å­˜ä¿¡æ¯æŸ¥è¯¢_ä¼˜åŒ–
      'ä¾›åº”å•†åº“å­˜æŸ¥è¯¢', // æœ‰ä¼˜åŒ–ç‰ˆæœ¬ï¼šä¾›åº”å•†åº“å­˜æŸ¥è¯¢_ä¼˜åŒ–  
      'ç‰©æ–™ä¸Šçº¿è·Ÿè¸ªæŸ¥è¯¢', // æœ‰ä¼˜åŒ–ç‰ˆæœ¬ï¼šç‰©æ–™ä¸Šçº¿è·Ÿè¸ªæŸ¥è¯¢_ä¼˜åŒ–
      'æ‰¹æ¬¡ä¸Šçº¿æƒ…å†µæŸ¥è¯¢', // æœ‰ä¼˜åŒ–ç‰ˆæœ¬ï¼šæ‰¹æ¬¡ä¸Šçº¿æƒ…å†µæŸ¥è¯¢_ä¼˜åŒ–
      'ç‰©æ–™æµ‹è¯•ç»“æœæŸ¥è¯¢', // æœ‰ä¼˜åŒ–ç‰ˆæœ¬ï¼šç‰©æ–™æµ‹è¯•ç»“æœæŸ¥è¯¢_ä¼˜åŒ–
      'NGæµ‹è¯•ç»“æœæŸ¥è¯¢', // æœ‰ä¼˜åŒ–ç‰ˆæœ¬ï¼šNGæµ‹è¯•ç»“æœæŸ¥è¯¢_ä¼˜åŒ–
      'æ‰¹æ¬¡ç»¼åˆä¿¡æ¯æŸ¥è¯¢', // æœ‰ä¼˜åŒ–ç‰ˆæœ¬ï¼šæ‰¹æ¬¡ç»¼åˆä¿¡æ¯æŸ¥è¯¢_ä¼˜åŒ–
      'å¼‚å¸¸æ‰¹æ¬¡è¯†åˆ«', // æœ‰ä¼˜åŒ–ç‰ˆæœ¬ï¼šå¼‚å¸¸æ‰¹æ¬¡è¯†åˆ«_ä¼˜åŒ–
      
      // 2. åŠŸèƒ½é‡å¤çš„è§„åˆ™
      'ç‰©æ–™åº“å­˜æŸ¥è¯¢', // ä¸ç‰©æ–™åº“å­˜ä¿¡æ¯æŸ¥è¯¢_ä¼˜åŒ–åŠŸèƒ½é‡å¤
      'åœ¨çº¿è·Ÿè¸ªæŸ¥è¯¢', // ä¸ç‰©æ–™ä¸Šçº¿è·Ÿè¸ªæŸ¥è¯¢_ä¼˜åŒ–åŠŸèƒ½é‡å¤
      'æµ‹è¯•NGæƒ…å†µæŸ¥è¯¢', // ä¸NGæµ‹è¯•ç»“æœæŸ¥è¯¢_ä¼˜åŒ–åŠŸèƒ½é‡å¤
      
      // 3. è¿‡äºå…·ä½“çš„ç‰©æ–™æŸ¥è¯¢ï¼ˆå¯ä»¥ç”¨å¤§ç±»æŸ¥è¯¢æ›¿ä»£ï¼‰
      'ç”µæ± ç‰©æ–™æŸ¥è¯¢', // å¯ä»¥ç”¨å……ç”µç±»æŸ¥è¯¢æ›¿ä»£
      'åŒ…è£…ç›’ç‰©æ–™æŸ¥è¯¢', // å¯ä»¥ç”¨åŒ…è£…ç±»æŸ¥è¯¢æ›¿ä»£
      'å……ç”µç±»ç‰©æ–™æŸ¥è¯¢', // ä¸å……ç”µç±»åº“å­˜æŸ¥è¯¢é‡å¤
      
      // 4. ä¸åˆç†çš„è§„åˆ™ï¼ˆä¸IQEè´¨é‡æ£€éªŒä¸šåŠ¡ä¸ç¬¦ï¼‰
      'åº“å­˜çŠ¶æ€æŸ¥è¯¢_é£é™©å†»ç»“ç‰©æ–™', // åç§°è¿‡é•¿ï¼ŒåŠŸèƒ½ä¸é£é™©åº“å­˜æŸ¥è¯¢é‡å¤
      
      // 5. åŠŸèƒ½æ¨¡ç³Šçš„è§„åˆ™
      'ç‰©æ–™ç›¸å…³æŸ¥è¯¢', // åŠŸèƒ½è¿‡äºæ¨¡ç³Š
      'ç²¾ç¡®ç‰©æ–™æŸ¥è¯¢', // åŠŸèƒ½ä¸æ™ºèƒ½ç‰©æ–™åŒ¹é…é‡å¤
      'æ•°æ®èŒƒå›´æç¤º', // ä¸æ˜¯æŸ¥è¯¢åŠŸèƒ½
      
      // 6. é‡å¤çš„å¯¹æ¯”åˆ†æ
      'ç‰©æ–™å¯¹æ¯”åˆ†æ' // åœ¨ç‰¹æ®Šè§„åˆ™ä¸­é‡å¤å‡ºç°
    ];
    
    console.log('=== è¯†åˆ«è¦åˆ é™¤çš„è§„åˆ™ ===');
    let deletedCount = 0;
    let notFoundCount = 0;
    
    for (const ruleName of rulesToDelete) {
      const rule = allRules.find(r => r.intent_name === ruleName);
      
      if (rule) {
        try {
          await connection.execute(
            'DELETE FROM nlp_intent_rules WHERE intent_name = ?',
            [ruleName]
          );
          console.log(`  âœ… å·²åˆ é™¤: ${ruleName}`);
          deletedCount++;
        } catch (error) {
          console.log(`  âŒ åˆ é™¤å¤±è´¥: ${ruleName} - ${error.message}`);
        }
      } else {
        console.log(`  âš ï¸  è§„åˆ™ä¸å­˜åœ¨: ${ruleName}`);
        notFoundCount++;
      }
    }
    
    console.log(`\nåˆ é™¤ç»Ÿè®¡: æˆåŠŸåˆ é™¤ ${deletedCount} æ¡ï¼Œæœªæ‰¾åˆ° ${notFoundCount} æ¡\n`);
    
    // æ£€æŸ¥åˆ é™¤åçš„è§„åˆ™æ•°é‡
    const [remainingRules] = await connection.execute(
      'SELECT COUNT(*) as count FROM nlp_intent_rules'
    );
    
    console.log(`ğŸ“Š åˆ é™¤åå‰©ä½™è§„åˆ™æ•°: ${remainingRules[0].count} æ¡\n`);
    
    // æ˜¾ç¤ºä¿ç•™çš„æ ¸å¿ƒè§„åˆ™åˆ†ç±»
    console.log('=== ä¿ç•™çš„æ ¸å¿ƒè§„åˆ™åˆ†ç±» ===');
    
    const coreRules = {
      'åº“å­˜ç›¸å…³': [
        'ç‰©æ–™åº“å­˜ä¿¡æ¯æŸ¥è¯¢_ä¼˜åŒ–',
        'ä¾›åº”å•†åº“å­˜æŸ¥è¯¢_ä¼˜åŒ–', 
        'åº“å­˜çŠ¶æ€æŸ¥è¯¢',
        'é£é™©åº“å­˜æŸ¥è¯¢',
        'é£é™©çŠ¶æ€ç‰©æ–™æŸ¥è¯¢',
        'ç”µæ± åº“å­˜æŸ¥è¯¢',
        'ç»“æ„ä»¶ç±»åº“å­˜æŸ¥è¯¢',
        'å…‰å­¦ç±»åº“å­˜æŸ¥è¯¢', 
        'å……ç”µç±»åº“å­˜æŸ¥è¯¢',
        'å£°å­¦ç±»åº“å­˜æŸ¥è¯¢',
        'åŒ…è£…ç±»åº“å­˜æŸ¥è¯¢'
      ],
      'ä¸Šçº¿ç›¸å…³': [
        'ç‰©æ–™ä¸Šçº¿æƒ…å†µæŸ¥è¯¢',
        'ä¾›åº”å•†ä¸Šçº¿æƒ…å†µæŸ¥è¯¢',
        'ç‰©æ–™ä¸Šçº¿è·Ÿè¸ªæŸ¥è¯¢_ä¼˜åŒ–',
        'æ‰¹æ¬¡ä¸Šçº¿æƒ…å†µæŸ¥è¯¢_ä¼˜åŒ–',
        'ç»“æ„ä»¶ç±»ä¸Šçº¿æƒ…å†µæŸ¥è¯¢',
        'å…‰å­¦ç±»ä¸Šçº¿æƒ…å†µæŸ¥è¯¢',
        'å……ç”µç±»ä¸Šçº¿æƒ…å†µæŸ¥è¯¢', 
        'å£°å­¦ç±»ä¸Šçº¿æƒ…å†µæŸ¥è¯¢',
        'åŒ…è£…ç±»ä¸Šçº¿æƒ…å†µæŸ¥è¯¢'
      ],
      'æµ‹è¯•ç›¸å…³': [
        'ç‰©æ–™æµ‹è¯•æƒ…å†µæŸ¥è¯¢',
        'æ‰¹æ¬¡æµ‹è¯•æƒ…å†µæŸ¥è¯¢',
        'ä¾›åº”å•†æµ‹è¯•æƒ…å†µæŸ¥è¯¢',
        'NGæµ‹è¯•ç»“æœæŸ¥è¯¢_ä¼˜åŒ–',
        'é¡¹ç›®æµ‹è¯•æƒ…å†µæŸ¥è¯¢',
        'åŸºçº¿æµ‹è¯•æƒ…å†µæŸ¥è¯¢',
        'Topç¼ºé™·æ’è¡ŒæŸ¥è¯¢',
        'ç»“æ„ä»¶ç±»æµ‹è¯•æƒ…å†µæŸ¥è¯¢',
        'å…‰å­¦ç±»æµ‹è¯•æƒ…å†µæŸ¥è¯¢',
        'å……ç”µç±»æµ‹è¯•æƒ…å†µæŸ¥è¯¢',
        'å£°å­¦ç±»æµ‹è¯•æƒ…å†µæŸ¥è¯¢', 
        'åŒ…è£…ç±»æµ‹è¯•æƒ…å†µæŸ¥è¯¢'
      ],
      'æ‰¹æ¬¡ç®¡ç†': [
        'æ‰¹æ¬¡ä¿¡æ¯æŸ¥è¯¢',
        'æ‰¹æ¬¡åº“å­˜ä¿¡æ¯æŸ¥è¯¢', 
        'æ‰¹æ¬¡ç»¼åˆä¿¡æ¯æŸ¥è¯¢_ä¼˜åŒ–',
        'å¼‚å¸¸æ‰¹æ¬¡è¯†åˆ«_ä¼˜åŒ–'
      ],
      'å¯¹æ¯”åˆ†æ': [
        'ä¾›åº”å•†å¯¹æ¯”åˆ†æ',
        'ç‰©æ–™å¤§ç±»åˆ«è´¨é‡å¯¹æ¯”',
        'ä¾›åº”å•†è´¨é‡è¯„çº§',
        'ç‰©æ–™å¤§ç±»åˆ«æœˆåº¦è´¨é‡è¶‹åŠ¿',
        'å¤§ç±»åˆ«Topä¸è‰¯åˆ†æ',
        'ç»“æ„ä»¶ç±»ä¾›åº”å•†è´¨é‡æ’è¡Œ',
        'å…‰å­¦ç±»ä¾›åº”å•†è´¨é‡æ’è¡Œ',
        'ç»“æ„ä»¶ç±»æ·±åº¦ä¸è‰¯åˆ†æ',
        'å…‰å­¦ç±»æ˜¾ç¤ºç¼ºé™·ä¸“é¡¹åˆ†æ'
      ],
      'ç‰¹æ®ŠåŠŸèƒ½': [
        'ä¾›åº”å•†ç‰©æ–™æŸ¥è¯¢',
        'ç‰©æ–™å¤§ç±»æŸ¥è¯¢', 
        'é¡¹ç›®ç‰©æ–™ä¸è‰¯æŸ¥è¯¢',
        'åŸºçº¿ç‰©æ–™ä¸è‰¯æŸ¥è¯¢',
        'ç‰©æ–™ä¸Šçº¿Topä¸è‰¯',
        'ç‰©æ–™æµ‹è¯•Topä¸è‰¯',
        'æœ¬æœˆæµ‹è¯•æ±‡æ€»',
        'é‡å¤ç¼ºé™·åˆ†æ',
        'æ™ºèƒ½ç‰©æ–™åŒ¹é…'
      ]
    };
    
    // éªŒè¯ä¿ç•™çš„è§„åˆ™æ˜¯å¦å­˜åœ¨
    for (const [category, rules] of Object.entries(coreRules)) {
      console.log(`\n--- ${category} ---`);
      let existCount = 0;
      
      for (const ruleName of rules) {
        const [ruleCheck] = await connection.execute(
          'SELECT COUNT(*) as count FROM nlp_intent_rules WHERE intent_name = ?',
          [ruleName]
        );
        
        if (ruleCheck[0].count > 0) {
          console.log(`  âœ… ${ruleName}`);
          existCount++;
        } else {
          console.log(`  âŒ ${ruleName} (å·²è¢«åˆ é™¤æˆ–ä¸å­˜åœ¨)`);
        }
      }
      
      console.log(`  ğŸ“Š ${category}: ${existCount}/${rules.length} æ¡è§„åˆ™ä¿ç•™`);
    }
    
    // æœ€ç»ˆç»Ÿè®¡
    const [finalRules] = await connection.execute(
      'SELECT COUNT(*) as count FROM nlp_intent_rules WHERE status = "active"'
    );
    
    console.log('\n=== æ¸…ç†å®Œæˆæ€»ç»“ ===');
    console.log(`ğŸ—‘ï¸  åˆ é™¤è§„åˆ™æ•°: ${deletedCount} æ¡`);
    console.log(`ğŸ“‹ æœ€ç»ˆè§„åˆ™æ•°: ${finalRules[0].count} æ¡æ¿€æ´»è§„åˆ™`);
    console.log(`ğŸ¯ è§„åˆ™åº“æ›´åŠ ç²¾ç®€å’Œé«˜æ•ˆï¼`);
    
    console.log('\nâœ… æ¸…ç†åçš„è§„åˆ™åº“ç‰¹ç‚¹:');
    console.log('1. æ¶ˆé™¤äº†é‡å¤è§„åˆ™ï¼Œä¿ç•™ä¼˜åŒ–ç‰ˆæœ¬');
    console.log('2. åˆ é™¤äº†åŠŸèƒ½æ¨¡ç³Šå’Œä¸åˆç†çš„è§„åˆ™'); 
    console.log('3. ä¿æŒäº†å®Œæ•´çš„ä¸šåŠ¡åŠŸèƒ½è¦†ç›–');
    console.log('4. æ‰€æœ‰ä¿ç•™è§„åˆ™éƒ½æŒ‰çœŸå®é¡µé¢å­—æ®µè®¾è®¡ä¼˜åŒ–');
    
  } catch (error) {
    console.error('âŒ æ¸…ç†è¿‡ç¨‹ä¸­å‡ºé”™:', error);
  } finally {
    await connection.end();
  }
}

cleanDuplicateUnreasonableRules();
