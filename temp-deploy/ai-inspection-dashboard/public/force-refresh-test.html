<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼ºåˆ¶åˆ·æ–°æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f7fa;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .big-button {
            font-size: 18px;
            padding: 15px 30px;
            background-color: #28a745;
        }
        .big-button:hover {
            background-color: #218838;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .step {
            margin: 15px 0;
            padding: 10px;
            border-left: 3px solid #007bff;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ å¼ºåˆ¶åˆ·æ–°æµ‹è¯•é¡µé¢</h1>
        
        <div class="status info">
            è¿™ä¸ªé¡µé¢å¸®åŠ©æ‚¨æµ‹è¯•å’Œå¼ºåˆ¶åˆ·æ–°æ™ºèƒ½åŠ©æ‰‹çš„è§„åˆ™æ•°æ®
        </div>
        
        <div class="step">
            <h3>ğŸ“‹ å½“å‰çŠ¶æ€æ£€æŸ¥</h3>
            <button onclick="checkCurrentStatus()">æ£€æŸ¥å½“å‰çŠ¶æ€</button>
            <div id="status-result"></div>
        </div>
        
        <div class="step">
            <h3>ğŸ”„ å¼ºåˆ¶åˆ·æ–°æ“ä½œ</h3>
            <button class="big-button" onclick="openAssistantAndRefresh()">ğŸš€ æ‰“å¼€åŠ©æ‰‹é¡µé¢å¹¶å¼ºåˆ¶åˆ·æ–°</button>
            <button onclick="clearBrowserCache()">ğŸ§¹ æ¸…é™¤æµè§ˆå™¨ç¼“å­˜</button>
        </div>
        
        <div class="step">
            <h3>ğŸ” æ‰‹åŠ¨éªŒè¯æ­¥éª¤</h3>
            <ol>
                <li>ç‚¹å‡»ä¸Šé¢çš„"æ‰“å¼€åŠ©æ‰‹é¡µé¢å¹¶å¼ºåˆ¶åˆ·æ–°"æŒ‰é’®</li>
                <li>åœ¨æ–°æ‰“å¼€çš„é¡µé¢ä¸­ï¼ŒæŒ‰ <code>Ctrl+Shift+R</code> å¼ºåˆ¶åˆ·æ–°</li>
                <li>æŸ¥çœ‹å·¦ä¾§é¢æ¿çš„è°ƒè¯•ä¿¡æ¯</li>
                <li>ç‚¹å‡»å·¦ä¾§é¢æ¿ä¸­çš„"å¼ºåˆ¶åˆ·æ–°"æŒ‰é’®</li>
                <li>æ£€æŸ¥è§„åˆ™æ•°é‡æ˜¯å¦æ˜¾ç¤ºä¸º 52 æ¡</li>
            </ol>
        </div>
        
        <div class="step">
            <h3>ğŸ› ï¸ æ•…éšœæ’é™¤</h3>
            <button onclick="runTroubleshooting()">è¿è¡Œæ•…éšœæ’é™¤</button>
            <div id="troubleshooting-result"></div>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        async function checkCurrentStatus() {
            const resultDiv = document.getElementById('status-result');
            resultDiv.innerHTML = '<p>ğŸ”„ æ£€æŸ¥ä¸­...</p>';
            
            try {
                // æ£€æŸ¥è§„åˆ™æ–‡ä»¶
                const response = await fetch('/data/rules.json?v=' + Date.now());
                const data = await response.json();
                
                resultDiv.innerHTML = `
                    <div style="background: #d4edda; padding: 10px; margin: 10px 0; border-radius: 4px;">
                        <h4>âœ… è§„åˆ™æ–‡ä»¶çŠ¶æ€æ­£å¸¸</h4>
                        <p><strong>æ€»è§„åˆ™æ•°:</strong> ${data.totalRules}</p>
                        <p><strong>åˆ†ç±»æ•°é‡:</strong> ${data.categories.length}</p>
                        <p><strong>æ–‡ä»¶å¤§å°:</strong> ${JSON.stringify(data).length} å­—ç¬¦</p>
                        <p><strong>æ£€æŸ¥æ—¶é—´:</strong> ${new Date().toLocaleString()}</p>
                    </div>
                `;
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div style="background: #f8d7da; padding: 10px; margin: 10px 0; border-radius: 4px;">
                        <h4>âŒ è§„åˆ™æ–‡ä»¶è®¿é—®å¤±è´¥</h4>
                        <p><strong>é”™è¯¯:</strong> ${error.message}</p>
                        <p><strong>å»ºè®®:</strong> æ£€æŸ¥å‰ç«¯æœåŠ¡å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œ</p>
                    </div>
                `;
            }
        }
        
        function openAssistantAndRefresh() {
            // æ‰“å¼€åŠ©æ‰‹é¡µé¢
            const assistantWindow = window.open('/assistant', '_blank');
            
            // ç­‰å¾…é¡µé¢åŠ è½½åæ‰§è¡Œåˆ·æ–°
            setTimeout(() => {
                if (assistantWindow) {
                    try {
                        // å°è¯•åœ¨æ–°çª—å£ä¸­æ‰§è¡Œå¼ºåˆ¶åˆ·æ–°
                        assistantWindow.location.reload(true);
                    } catch (e) {
                        console.log('æ— æ³•è‡ªåŠ¨åˆ·æ–°æ–°çª—å£ï¼Œè¯·æ‰‹åŠ¨æŒ‰ Ctrl+Shift+R');
                    }
                }
            }, 2000);
            
            alert('å·²æ‰“å¼€åŠ©æ‰‹é¡µé¢ï¼\n\nè¯·åœ¨æ–°é¡µé¢ä¸­ï¼š\n1. æŒ‰ Ctrl+Shift+R å¼ºåˆ¶åˆ·æ–°\n2. ç‚¹å‡»å·¦ä¾§é¢æ¿çš„"å¼ºåˆ¶åˆ·æ–°"æŒ‰é’®\n3. æ£€æŸ¥è§„åˆ™æ•°é‡æ˜¯å¦ä¸º 52 æ¡');
        }
        
        function clearBrowserCache() {
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    names.forEach(function(name) {
                        caches.delete(name);
                    });
                });
            }
            
            // æ¸…é™¤localStorage
            localStorage.clear();
            sessionStorage.clear();
            
            alert('å·²æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼\nè¯·åˆ·æ–°åŠ©æ‰‹é¡µé¢æŸ¥çœ‹æ•ˆæœã€‚');
        }
        
        async function runTroubleshooting() {
            const resultDiv = document.getElementById('troubleshooting-result');
            resultDiv.innerHTML = '<p>ğŸ”„ è¿è¡Œæ•…éšœæ’é™¤...</p>';
            
            const issues = [];
            const solutions = [];
            
            try {
                // 1. æ£€æŸ¥è§„åˆ™æ–‡ä»¶è®¿é—®
                const response = await fetch('/data/rules.json?v=' + Date.now());
                if (!response.ok) {
                    issues.push(`è§„åˆ™æ–‡ä»¶HTTPé”™è¯¯: ${response.status}`);
                    solutions.push('æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨äº public/data/rules.json');
                }
                
                // 2. æ£€æŸ¥JSONæ ¼å¼
                const data = await response.json();
                if (!data.categories || !Array.isArray(data.categories)) {
                    issues.push('è§„åˆ™æ–‡ä»¶æ ¼å¼é”™è¯¯');
                    solutions.push('æ£€æŸ¥JSONæ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®');
                }
                
                // 3. æ£€æŸ¥è§„åˆ™æ•°é‡
                if (data.totalRules !== 52) {
                    issues.push(`è§„åˆ™æ•°é‡ä¸åŒ¹é…: æœŸæœ›52æ¡ï¼Œå®é™…${data.totalRules}æ¡`);
                    solutions.push('é‡æ–°ç”Ÿæˆè§„åˆ™æ–‡ä»¶');
                }
                
                // 4. æ£€æŸ¥å‰ç«¯æœåŠ¡
                const frontendCheck = await fetch('/');
                if (!frontendCheck.ok) {
                    issues.push('å‰ç«¯æœåŠ¡å¼‚å¸¸');
                    solutions.push('é‡å¯å‰ç«¯å¼€å‘æœåŠ¡å™¨');
                }
                
            } catch (error) {
                issues.push(`ç½‘ç»œé”™è¯¯: ${error.message}`);
                solutions.push('æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒæœåŠ¡å™¨çŠ¶æ€');
            }
            
            let html = '';
            if (issues.length === 0) {
                html = `
                    <div style="background: #d4edda; padding: 10px; margin: 10px 0; border-radius: 4px;">
                        <h4>âœ… æœªå‘ç°æŠ€æœ¯é—®é¢˜</h4>
                        <p>è§„åˆ™æ–‡ä»¶å’ŒæœåŠ¡å™¨çŠ¶æ€æ­£å¸¸ã€‚å¦‚æœå‰ç«¯ä»æœªæ›´æ–°ï¼Œå¯èƒ½æ˜¯æµè§ˆå™¨ç¼“å­˜é—®é¢˜ã€‚</p>
                        <p><strong>å»ºè®®:</strong></p>
                        <ul>
                            <li>å¼ºåˆ¶åˆ·æ–°æµè§ˆå™¨ (Ctrl+Shift+R)</li>
                            <li>æ¸…é™¤æµè§ˆå™¨ç¼“å­˜</li>
                            <li>åœ¨åŠ©æ‰‹é¡µé¢ç‚¹å‡»"å¼ºåˆ¶åˆ·æ–°"æŒ‰é’®</li>
                        </ul>
                    </div>
                `;
            } else {
                html = `
                    <div style="background: #f8d7da; padding: 10px; margin: 10px 0; border-radius: 4px;">
                        <h4>âŒ å‘ç°é—®é¢˜</h4>
                        <p><strong>é—®é¢˜åˆ—è¡¨:</strong></p>
                        <ul>${issues.map(issue => `<li>${issue}</li>`).join('')}</ul>
                        <p><strong>è§£å†³æ–¹æ¡ˆ:</strong></p>
                        <ul>${solutions.map(solution => `<li>${solution}</li>`).join('')}</ul>
                    </div>
                `;
            }
            
            resultDiv.innerHTML = html;
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥çŠ¶æ€
        window.addEventListener('load', checkCurrentStatus);
    </script>
</body>
</html>
