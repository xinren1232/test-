<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒè¯•è§„åˆ™åŠ è½½</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .debug-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .result {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” è§„åˆ™åŠ è½½è°ƒè¯•å·¥å…·</h1>
        
        <div class="debug-section">
            <h3>1. æ£€æŸ¥åç«¯APIè¿æ¥</h3>
            <button onclick="checkBackendAPI()">æ£€æŸ¥åç«¯</button>
            <div id="backendResult" class="result"></div>
        </div>
        
        <div class="debug-section">
            <h3>2. æ¨¡æ‹Ÿå‰ç«¯è§„åˆ™åˆ†ç±»é€»è¾‘</h3>
            <button onclick="simulateFrontendLogic()">æ¨¡æ‹Ÿåˆ†ç±»</button>
            <div id="frontendResult" class="result"></div>
        </div>
        
        <div class="debug-section">
            <h3>3. æ£€æŸ¥å‰ç«¯é¡µé¢çŠ¶æ€</h3>
            <button onclick="checkFrontendPage()">æ£€æŸ¥é¡µé¢</button>
            <div id="pageResult" class="result"></div>
        </div>
        
        <div class="debug-section">
            <h3>4. å¼ºåˆ¶åˆ·æ–°è§„åˆ™</h3>
            <button onclick="forceRefreshRules()">å¼ºåˆ¶åˆ·æ–°</button>
            <div id="refreshResult" class="result"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001';
        
        async function checkBackendAPI() {
            const resultDiv = document.getElementById('backendResult');
            resultDiv.textContent = 'æ­£åœ¨æ£€æŸ¥åç«¯API...';
            
            try {
                // æ£€æŸ¥å¥åº·çŠ¶æ€
                const healthResponse = await fetch(`${API_BASE}/health`);
                const healthResult = await healthResponse.json();
                
                // æ£€æŸ¥è§„åˆ™API
                const rulesResponse = await fetch(`${API_BASE}/api/rules`);
                const rulesResult = await rulesResponse.json();
                
                let output = 'âœ… åç«¯APIæ£€æŸ¥ç»“æœ:\n\n';
                output += `å¥åº·çŠ¶æ€: ${healthResult.status || 'OK'}\n`;
                output += `è§„åˆ™API: ${rulesResult.success ? 'æ­£å¸¸' : 'å¼‚å¸¸'}\n`;
                output += `è§„åˆ™æ•°é‡: ${rulesResult.data ? rulesResult.data.length : 0}\n\n`;
                
                if (rulesResult.data && rulesResult.data.length > 0) {
                    output += 'è§„åˆ™åˆ†ç±»ç»Ÿè®¡:\n';
                    const categories = {};
                    rulesResult.data.forEach(rule => {
                        const cat = rule.category || 'æœªåˆ†ç±»';
                        categories[cat] = (categories[cat] || 0) + 1;
                    });
                    
                    Object.entries(categories).forEach(([cat, count]) => {
                        output += `  ${cat}: ${count} æ¡\n`;
                    });
                }
                
                resultDiv.className = 'result success';
                resultDiv.textContent = output;
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ åç«¯APIæ£€æŸ¥å¤±è´¥: ${error.message}`;
            }
        }
        
        async function simulateFrontendLogic() {
            const resultDiv = document.getElementById('frontendResult');
            resultDiv.textContent = 'æ­£åœ¨æ¨¡æ‹Ÿå‰ç«¯åˆ†ç±»é€»è¾‘...';
            
            try {
                const response = await fetch(`${API_BASE}/api/rules`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    // æ¨¡æ‹Ÿå‰ç«¯åˆ†ç±»é€»è¾‘
                    const categorizedRules = {
                        'åº“å­˜åœºæ™¯': [],
                        'ä¸Šçº¿åœºæ™¯': [],
                        'æµ‹è¯•åœºæ™¯': [],
                        'é«˜çº§åœºæ™¯': []
                    };
                    
                    result.data.forEach(rule => {
                        const desc = rule.description ? rule.description.toLowerCase() : '';
                        const target = rule.action_target ? rule.action_target.toLowerCase() : '';
                        
                        if (desc.includes('åº“å­˜') || target.includes('inventory')) {
                            categorizedRules['åº“å­˜åœºæ™¯'].push(rule);
                        } else if (desc.includes('ä¸Šçº¿') || target.includes('online_tracking')) {
                            categorizedRules['ä¸Šçº¿åœºæ™¯'].push(rule);
                        } else if (desc.includes('æµ‹è¯•') || desc.includes('æ£€éªŒ') || target.includes('lab_tests')) {
                            categorizedRules['æµ‹è¯•åœºæ™¯'].push(rule);
                        } else {
                            categorizedRules['é«˜çº§åœºæ™¯'].push(rule);
                        }
                    });
                    
                    let output = 'ğŸ“Š å‰ç«¯åˆ†ç±»é€»è¾‘æ¨¡æ‹Ÿç»“æœ:\n\n';
                    Object.entries(categorizedRules).forEach(([name, rules]) => {
                        output += `${name}: ${rules.length} æ¡è§„åˆ™\n`;
                        if (rules.length > 0) {
                            output += `  ç¤ºä¾‹: ${rules.slice(0, 3).map(r => r.intent_name).join(', ')}\n`;
                        }
                        output += '\n';
                    });
                    
                    resultDiv.className = 'result success';
                    resultDiv.textContent = output;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ è·å–è§„åˆ™æ•°æ®å¤±è´¥: ${JSON.stringify(result, null, 2)}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ æ¨¡æ‹Ÿå¤±è´¥: ${error.message}`;
            }
        }
        
        function checkFrontendPage() {
            const resultDiv = document.getElementById('pageResult');
            
            let output = 'ğŸ” å‰ç«¯é¡µé¢æ£€æŸ¥:\n\n';
            output += `å½“å‰URL: ${window.location.href}\n`;
            output += `ç”¨æˆ·ä»£ç†: ${navigator.userAgent}\n`;
            output += `æ—¶é—´æˆ³: ${new Date().toLocaleString()}\n\n`;
            
            // æ£€æŸ¥æ˜¯å¦èƒ½è®¿é—®æ™ºèƒ½é—®ç­”é¡µé¢
            output += 'æ­£åœ¨æ£€æŸ¥æ™ºèƒ½é—®ç­”é¡µé¢...\n';
            
            // å°è¯•åœ¨æ–°çª—å£æ‰“å¼€æ™ºèƒ½é—®ç­”é¡µé¢
            const assistantUrl = 'http://localhost:5174/assistant';
            output += `æ™ºèƒ½é—®ç­”é¡µé¢URL: ${assistantUrl}\n`;
            output += 'è¯·æ‰‹åŠ¨æ£€æŸ¥è¯¥é¡µé¢æ˜¯å¦æ˜¾ç¤ºæ­£ç¡®çš„è§„åˆ™åˆ†ç±»\n\n';
            
            output += 'é¢„æœŸæ˜¾ç¤º:\n';
            output += 'ğŸ“¦ åº“å­˜åœºæ™¯ (å±•å¼€)\n';
            output += 'ğŸ­ ä¸Šçº¿åœºæ™¯ (å±•å¼€)\n';
            output += 'ğŸ”¬ æµ‹è¯•åœºæ™¯ (å±•å¼€)\n';
            output += 'ğŸ“ˆ é«˜çº§åœºæ™¯ (æŠ˜å )\n';
            
            resultDiv.className = 'result success';
            resultDiv.textContent = output;
            
            // åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€æ™ºèƒ½é—®ç­”é¡µé¢
            window.open(assistantUrl, '_blank');
        }
        
        async function forceRefreshRules() {
            const resultDiv = document.getElementById('refreshResult');
            resultDiv.textContent = 'æ­£åœ¨å¼ºåˆ¶åˆ·æ–°è§„åˆ™...';
            
            try {
                // æ·»åŠ æ—¶é—´æˆ³å‚æ•°å¼ºåˆ¶åˆ·æ–°
                const timestamp = Date.now();
                const response = await fetch(`${API_BASE}/api/rules?t=${timestamp}`, {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    let output = 'âœ… å¼ºåˆ¶åˆ·æ–°æˆåŠŸ!\n\n';
                    output += `è·å–æ—¶é—´: ${new Date().toLocaleString()}\n`;
                    output += `è§„åˆ™æ€»æ•°: ${result.data.length}\n\n`;
                    
                    // åˆ†ç±»ç»Ÿè®¡
                    const categories = {};
                    result.data.forEach(rule => {
                        const cat = rule.category || 'æœªåˆ†ç±»';
                        categories[cat] = (categories[cat] || 0) + 1;
                    });
                    
                    output += 'åˆ†ç±»ç»Ÿè®¡:\n';
                    Object.entries(categories).forEach(([cat, count]) => {
                        output += `  ${cat}: ${count} æ¡\n`;
                    });
                    
                    output += '\nå»ºè®®æ“ä½œ:\n';
                    output += '1. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜\n';
                    output += '2. ç¡¬åˆ·æ–°æ™ºèƒ½é—®ç­”é¡µé¢ (Ctrl+F5)\n';
                    output += '3. æ£€æŸ¥æµè§ˆå™¨å¼€å‘è€…å·¥å…·çš„æ§åˆ¶å°\n';
                    
                    resultDiv.className = 'result success';
                    resultDiv.textContent = output;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ åˆ·æ–°å¤±è´¥: ${JSON.stringify(result, null, 2)}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ åˆ·æ–°å¤±è´¥: ${error.message}`;
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.onload = function() {
            checkBackendAPI();
        };
    </script>
</body>
</html>
