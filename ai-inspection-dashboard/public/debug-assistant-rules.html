<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½åŠ©æ‰‹è§„åˆ™è°ƒè¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f7fa;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .warning { background-color: #fff3cd; color: #856404; }
        .debug-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f8f9fa;
        }
        .debug-section h3 {
            margin-top: 0;
            color: #495057;
        }
        pre {
            background: #f1f3f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .rule-group {
            margin: 10px 0;
            padding: 10px;
            border-left: 3px solid #007bff;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” æ™ºèƒ½åŠ©æ‰‹è§„åˆ™è°ƒè¯•é¡µé¢</h1>
        
        <div id="status" class="status info">
            æ­£åœ¨è¿›è¡Œè°ƒè¯•æ£€æŸ¥...
        </div>
        
        <div>
            <button onclick="runFullDiagnostic()">ğŸ”„ å®Œæ•´è¯Šæ–­</button>
            <button onclick="testRulesLoading()">ğŸ“Š æµ‹è¯•è§„åˆ™åŠ è½½</button>
            <button onclick="simulateAssistantPage()">ğŸ¤– æ¨¡æ‹ŸåŠ©æ‰‹é¡µé¢</button>
            <button onclick="checkNetworkRequests()">ğŸŒ æ£€æŸ¥ç½‘ç»œè¯·æ±‚</button>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        let diagnosticResults = {};

        async function runFullDiagnostic() {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            
            statusDiv.className = 'status info';
            statusDiv.textContent = 'ğŸ”„ æ­£åœ¨è¿è¡Œå®Œæ•´è¯Šæ–­...';
            
            resultsDiv.innerHTML = '';
            diagnosticResults = {};
            
            // 1. æµ‹è¯•è§„åˆ™æ–‡ä»¶è®¿é—®
            await testRulesFileAccess();
            
            // 2. æµ‹è¯•è§„åˆ™æ•°æ®ç»“æ„
            await testRulesDataStructure();
            
            // 3. æ¨¡æ‹Ÿå‰ç«¯åŠ è½½é€»è¾‘
            await simulateLoadRulesData();
            
            // 4. æ£€æŸ¥å¯èƒ½çš„é”™è¯¯
            await checkPossibleErrors();
            
            // æ˜¾ç¤ºç»“æœ
            displayDiagnosticResults();
        }
        
        async function testRulesFileAccess() {
            try {
                console.log('ğŸ” æµ‹è¯•è§„åˆ™æ–‡ä»¶è®¿é—®...');
                
                const response = await fetch('/data/rules.json');
                diagnosticResults.fileAccess = {
                    success: response.ok,
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers.entries())
                };
                
                if (response.ok) {
                    const data = await response.json();
                    diagnosticResults.fileData = {
                        totalRules: data.totalRules,
                        categoriesCount: data.categories.length,
                        categories: data.categories.map(cat => ({
                            name: cat.name,
                            rulesCount: cat.rules.length
                        }))
                    };
                }
                
            } catch (error) {
                diagnosticResults.fileAccess = {
                    success: false,
                    error: error.message
                };
            }
        }
        
        async function testRulesDataStructure() {
            try {
                console.log('ğŸ” æµ‹è¯•è§„åˆ™æ•°æ®ç»“æ„...');
                
                const response = await fetch('/data/rules.json');
                const data = await response.json();
                
                // æ£€æŸ¥æ•°æ®ç»“æ„
                const structureCheck = {
                    hasCategories: Array.isArray(data.categories),
                    hasTotalRules: typeof data.totalRules === 'number',
                    hasLastUpdated: !!data.lastUpdated,
                    categoryStructure: []
                };
                
                if (data.categories) {
                    data.categories.forEach(category => {
                        const categoryCheck = {
                            name: category.name,
                            hasRules: Array.isArray(category.rules),
                            rulesCount: category.rules ? category.rules.length : 0,
                            sampleRule: category.rules && category.rules[0] ? {
                                hasName: !!category.rules[0].name,
                                hasExample: !!category.rules[0].example,
                                hasDescription: !!category.rules[0].description,
                                hasCategory: !!category.rules[0].category
                            } : null
                        };
                        structureCheck.categoryStructure.push(categoryCheck);
                    });
                }
                
                diagnosticResults.dataStructure = structureCheck;
                
            } catch (error) {
                diagnosticResults.dataStructure = {
                    error: error.message
                };
            }
        }
        
        async function simulateLoadRulesData() {
            try {
                console.log('ğŸ” æ¨¡æ‹Ÿå‰ç«¯åŠ è½½é€»è¾‘...');
                
                // æ¨¡æ‹Ÿå‰ç«¯çš„loadRulesDataå‡½æ•°
                const response = await fetch('/data/rules.json');
                const rulesData = await response.json();
                
                // å›¾æ ‡æ˜ å°„
                const categoryIcons = {
                    'åº“å­˜åœºæ™¯': 'ğŸ“¦',
                    'ä¸Šçº¿åœºæ™¯': 'ğŸš€',
                    'æµ‹è¯•åœºæ™¯': 'ğŸ§ª',
                    'æ‰¹æ¬¡åœºæ™¯': 'ğŸ“‹',
                    'å¯¹æ¯”åœºæ™¯': 'ğŸ”',
                    'ç»¼åˆåœºæ™¯': 'ğŸ“Š'
                };
                
                // å°†è§„åˆ™æŒ‰åˆ†ç±»ç»„ç»‡
                const organizedRules = {
                    basic: [],
                    advanced: [],
                    charts: []
                };
                
                rulesData.categories.forEach(category => {
                    const icon = categoryIcons[category.name] || 'ğŸ“‹';
                    
                    category.rules.forEach(rule => {
                        const ruleItem = {
                            name: rule.name,
                            query: rule.example || rule.description,
                            icon: icon,
                            category: rule.category,
                            description: rule.description
                        };
                        
                        // æ ¹æ®åˆ†ç±»åˆ†é…åˆ°ä¸åŒç»„
                        if (category.name === 'åº“å­˜åœºæ™¯' || category.name === 'ä¸Šçº¿åœºæ™¯' || category.name === 'æµ‹è¯•åœºæ™¯') {
                            organizedRules.basic.push(ruleItem);
                        } else if (category.name === 'æ‰¹æ¬¡åœºæ™¯' || category.name === 'å¯¹æ¯”åœºæ™¯') {
                            organizedRules.advanced.push(ruleItem);
                        } else {
                            organizedRules.charts.push(ruleItem);
                        }
                    });
                });
                
                diagnosticResults.simulatedLoading = {
                    success: true,
                    basicRulesCount: organizedRules.basic.length,
                    advancedRulesCount: organizedRules.advanced.length,
                    chartsRulesCount: organizedRules.charts.length,
                    sampleBasicRules: organizedRules.basic.slice(0, 3).map(r => r.name),
                    organizedRules: organizedRules
                };
                
            } catch (error) {
                diagnosticResults.simulatedLoading = {
                    success: false,
                    error: error.message
                };
            }
        }
        
        async function checkPossibleErrors() {
            console.log('ğŸ” æ£€æŸ¥å¯èƒ½çš„é”™è¯¯...');
            
            const possibleIssues = [];
            
            // æ£€æŸ¥CORS
            try {
                const response = await fetch('/data/rules.json', { method: 'HEAD' });
                if (!response.ok) {
                    possibleIssues.push(`HTTPé”™è¯¯: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                possibleIssues.push(`ç½‘ç»œé”™è¯¯: ${error.message}`);
            }
            
            // æ£€æŸ¥JSONæ ¼å¼
            try {
                const response = await fetch('/data/rules.json');
                const text = await response.text();
                JSON.parse(text);
            } catch (error) {
                possibleIssues.push(`JSONæ ¼å¼é”™è¯¯: ${error.message}`);
            }
            
            // æ£€æŸ¥ç¼“å­˜
            const cacheCheck = await fetch('/data/rules.json', { 
                cache: 'no-cache',
                headers: { 'Cache-Control': 'no-cache' }
            });
            
            diagnosticResults.possibleIssues = possibleIssues;
        }
        
        function displayDiagnosticResults() {
            const resultsDiv = document.getElementById('results');
            const statusDiv = document.getElementById('status');
            
            let html = '<div class="debug-section"><h3>ğŸ“Š è¯Šæ–­ç»“æœ</h3>';
            
            // æ–‡ä»¶è®¿é—®ç»“æœ
            if (diagnosticResults.fileAccess) {
                html += `<div class="rule-group">
                    <h4>ğŸ“ æ–‡ä»¶è®¿é—®æµ‹è¯•</h4>
                    <p><strong>çŠ¶æ€:</strong> ${diagnosticResults.fileAccess.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}</p>
                    ${diagnosticResults.fileAccess.status ? `<p><strong>HTTPçŠ¶æ€:</strong> ${diagnosticResults.fileAccess.status}</p>` : ''}
                    ${diagnosticResults.fileAccess.error ? `<p><strong>é”™è¯¯:</strong> ${diagnosticResults.fileAccess.error}</p>` : ''}
                </div>`;
            }
            
            // æ•°æ®ç»“æ„ç»“æœ
            if (diagnosticResults.fileData) {
                html += `<div class="rule-group">
                    <h4>ğŸ“Š æ•°æ®å†…å®¹</h4>
                    <p><strong>æ€»è§„åˆ™æ•°:</strong> ${diagnosticResults.fileData.totalRules}</p>
                    <p><strong>åˆ†ç±»æ•°é‡:</strong> ${diagnosticResults.fileData.categoriesCount}</p>
                    <p><strong>åˆ†ç±»è¯¦æƒ…:</strong></p>
                    <ul>
                        ${diagnosticResults.fileData.categories.map(cat => 
                            `<li>${cat.name}: ${cat.rulesCount}æ¡è§„åˆ™</li>`
                        ).join('')}
                    </ul>
                </div>`;
            }
            
            // æ¨¡æ‹ŸåŠ è½½ç»“æœ
            if (diagnosticResults.simulatedLoading) {
                if (diagnosticResults.simulatedLoading.success) {
                    html += `<div class="rule-group">
                        <h4>ğŸ¤– æ¨¡æ‹Ÿå‰ç«¯åŠ è½½</h4>
                        <p><strong>çŠ¶æ€:</strong> âœ… æˆåŠŸ</p>
                        <p><strong>åŸºç¡€è§„åˆ™:</strong> ${diagnosticResults.simulatedLoading.basicRulesCount}æ¡</p>
                        <p><strong>é«˜çº§è§„åˆ™:</strong> ${diagnosticResults.simulatedLoading.advancedRulesCount}æ¡</p>
                        <p><strong>å›¾è¡¨è§„åˆ™:</strong> ${diagnosticResults.simulatedLoading.chartsRulesCount}æ¡</p>
                        <p><strong>ç¤ºä¾‹åŸºç¡€è§„åˆ™:</strong></p>
                        <ul>
                            ${diagnosticResults.simulatedLoading.sampleBasicRules.map(name => 
                                `<li>${name}</li>`
                            ).join('')}
                        </ul>
                    </div>`;
                } else {
                    html += `<div class="rule-group">
                        <h4>ğŸ¤– æ¨¡æ‹Ÿå‰ç«¯åŠ è½½</h4>
                        <p><strong>çŠ¶æ€:</strong> âŒ å¤±è´¥</p>
                        <p><strong>é”™è¯¯:</strong> ${diagnosticResults.simulatedLoading.error}</p>
                    </div>`;
                }
            }
            
            // å¯èƒ½çš„é—®é¢˜
            if (diagnosticResults.possibleIssues && diagnosticResults.possibleIssues.length > 0) {
                html += `<div class="rule-group">
                    <h4>âš ï¸ å‘ç°çš„é—®é¢˜</h4>
                    <ul>
                        ${diagnosticResults.possibleIssues.map(issue => 
                            `<li>${issue}</li>`
                        ).join('')}
                    </ul>
                </div>`;
            }
            
            html += '</div>';
            
            // å»ºè®®
            html += `<div class="debug-section">
                <h3>ğŸ”§ ä¿®å¤å»ºè®®</h3>
                <ol>
                    <li>å¦‚æœæ–‡ä»¶è®¿é—®å¤±è´¥ï¼Œæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨äº public/data/rules.json</li>
                    <li>å¦‚æœæ•°æ®åŠ è½½æˆåŠŸä½†å‰ç«¯æœªæ›´æ–°ï¼Œå°è¯•å¼ºåˆ¶åˆ·æ–°æµè§ˆå™¨ (Ctrl+Shift+R)</li>
                    <li>æ£€æŸ¥æµè§ˆå™¨å¼€å‘è€…å·¥å…·çš„Consoleæ ‡ç­¾æ˜¯å¦æœ‰JavaScripté”™è¯¯</li>
                    <li>æ£€æŸ¥Networkæ ‡ç­¾ä¸­çš„è¯·æ±‚çŠ¶æ€</li>
                    <li>åœ¨æ™ºèƒ½åŠ©æ‰‹é¡µé¢ç‚¹å‡»"å¼ºåˆ¶åˆ·æ–°"æŒ‰é’®</li>
                </ol>
            </div>`;
            
            resultsDiv.innerHTML = html;
            
            // æ›´æ–°çŠ¶æ€
            if (diagnosticResults.fileAccess && diagnosticResults.fileAccess.success && 
                diagnosticResults.simulatedLoading && diagnosticResults.simulatedLoading.success) {
                statusDiv.className = 'status success';
                statusDiv.textContent = 'âœ… è¯Šæ–­å®Œæˆ - è§„åˆ™åŠ è½½åº”è¯¥æ­£å¸¸å·¥ä½œ';
            } else {
                statusDiv.className = 'status warning';
                statusDiv.textContent = 'âš ï¸ è¯Šæ–­å®Œæˆ - å‘ç°æ½œåœ¨é—®é¢˜';
            }
        }
        
        async function testRulesLoading() {
            await testRulesFileAccess();
            await testRulesDataStructure();
            displayDiagnosticResults();
        }
        
        async function simulateAssistantPage() {
            await simulateLoadRulesData();
            displayDiagnosticResults();
        }
        
        async function checkNetworkRequests() {
            console.log('ğŸŒ æ£€æŸ¥ç½‘ç»œè¯·æ±‚...');
            // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤šç½‘ç»œç›¸å…³çš„æ£€æŸ¥
            await checkPossibleErrors();
            displayDiagnosticResults();
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œè¯Šæ–­
        window.addEventListener('load', runFullDiagnostic);
    </script>
</body>
</html>
